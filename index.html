<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PlayMaker Tracker - DEV</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
        padding: 10px;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: white;
        color: #333;
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
      }

      .header h1 {
        font-size: 18px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      /* Section 1: Game Info */
      .section-1 {
        padding: 10px;
        background: #fafafa;
        border-bottom: 1px solid #e0e0e0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .section-1 input {
        padding: 8px;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        font-size: 13px;
      }

      /* Section 2.1: Tabs */
      .section-2-1 {
        display: flex;
        background: #fafafa;
        border-bottom: 1px solid #e0e0e0;
      }

      .tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        color: #666;
        background: #f0f0f0;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab.active {
        background: white;
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab:hover:not(.active) {
        background: #e8e8e8;
      }

      .tab-content {
        display: none;
        padding: 12px;
        padding-bottom: 80px; /* Space for action history button */
      }

      .tab-content.active {
        display: block;
      }

      /* Common sections */
      .section-label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 4px;
        letter-spacing: 0.5px;
      }

      .checkbox-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #fafafa;
        border-radius: 4px;
        margin-bottom: 6px;
        cursor: pointer;
      }

      .checkbox-option input[type='checkbox'] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .checkbox-option label {
        cursor: pointer;
        font-weight: 500;
        font-size: 13px;
      }

      /* Role/Status container */
      .role-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .role-container.with-relief {
        grid-template-columns: 1fr 1fr;
      }

      .role-container select,
      .role-container input {
        padding: 8px;
        border: 1px solid #d0d0d0;
        border-radius: 4px;
        font-size: 13px;
      }

      #reliefInningEntry {
        display: none;
      }

      #reliefInningEntry.show {
        display: block;
      }

      #reliefInningEntry input {
        width: 100%;
      }

      /* Counters */
      .counters-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .counter-wrapper {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 10px;
      }

      .counter-label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 6px;
        text-align: center;
      }

      .counter-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .counter-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s;
      }

      .counter-btn:active {
        transform: scale(0.9);
      }

      .counter-btn.minus {
        background: rgba(73, 65, 65, 0.3);
      }

      .counter-btn.plus {
        background: rgba(73, 65, 65, 0.3);
      }

      .counter-display {
        font-size: 24px;
        font-weight: 700;
        min-width: 40px;
        text-align: center;
      }

      .strike-wrapper {
        border-style: solid;
        border-color: #4caf50;
      }

      .ball-wrapper {
        border-style: solid;
        border-color: #ffc107;
      }

      /* MODAL STYLES */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9998;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      #editActionModal {
        z-index: 9999;
      }

      .modal-overlay.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 16px;
        font-weight: 700;
        color: #333;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f0f0f0;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }

      .modal-body {
        padding: 16px;
      }

      .modal-button-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .modal-button {
        padding: 20px;
        background: #f8f9fa;
        color: #000000;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .modal-button:active {
        transform: scale(0.95);
      }

      .modal-button.secondary {
        background: #f0f0f0;
        color: #666;
      }

      .modal-button.skip {
        grid-column: 1 / -1;
        background: #f8f9fa;
        color: #666;
        padding: 12px;
        font-size: 14px;
        margin-top: 5px;
      }

      .modal-button.outcome {
        background: #f8f9fa;
        border: 2px solid #f44336;
      }

      .modal-button.outcome.out {
        background: #f8f9fa;
        border: 2px solid #ff9800;
      }

      .modal-button.hit-type {
        background: #f8f9fa;
        border: 2px solid #2196f3;
      }

      /* Velocity Input in Modal */
      .velocity-modal-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #d0d0d0;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 10px;
        text-align: center;
      }

      /* Additional Events Grid */
      .events-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 12px 0;
      }

      .event-item {
        border: 2px solid #000;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 8px;
      }

      .event-label {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 6px;
        text-align: center;
      }

      .event-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .event-btn {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 50%;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background: rgba(73, 65, 65, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .event-display {
        font-size: 20px;
        font-weight: 700;
        min-width: 30px;
        text-align: center;
      }

      /* Runs grid */
      .runs-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 12px 0;
      }

      .run-item {
        border-radius: 6px;
        padding: 8px;
      }

      .run-item.runs {
        border: 2px solid #ff5722;
        background: #f8f9fa;
      }

      .run-item.earned-runs {
        border: 2px solid #795548;
        background: #f8f9fa;
      }

      /* Ball in Play Button */
      .ball-in-play-btn {
        width: 100%;
        padding: 16px;
        background: #f8f9fa;
        border: 2px solid #f44336;
        color: #000000;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        margin: 12px 0;
      }

      .ball-in-play-btn:active {
        transform: scale(0.98);
      }

      /* Action History Button (Fixed at bottom) */
      .action-history-btn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 460px;
        padding: 14px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      /* Action History List */
      .action-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .action-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .action-details {
        flex: 1;
      }

      .action-type {
        font-weight: 700;
        font-size: 14px;
        color: #333;
        margin-bottom: 2px;
      }

      .action-meta {
        font-size: 11px;
        color: #666;
      }

      .action-delete {
        width: 32px;
        height: 32px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .empty-history {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-style: italic;
      }

      /* Stats */
      .section-3 {
        background: #fafafa;
        padding: 12px;
        padding-bottom: 80px; /* Space for action history button */
        border-top: 1px solid #e0e0e0;
      }

      .section-3-title {
        font-size: 14px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 10px;
        text-align: center;
      }

      .section-3-1 {
        background: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .stat-item {
        text-align: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .stat-label {
        font-size: 10px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 18px;
        font-weight: 700;
        color: #667eea;
      }

      .section-3-2 {
        display: none;
        background: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
      }

      .section-3-2.show {
        display: block;
      }

      .section-3-2-title {
        font-size: 13px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 8px;
      }

      .pitch-type-stat {
        padding: 6px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 6px;
        font-size: 11px;
        line-height: 1.4;
      }

      .pitch-type-stat strong {
        color: #667eea;
      }

      .section-3-3 {
        display: grid;
        gap: 6px;
      }

      .export-btn {
        width: 100%;
        padding: 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .reset-btn {
        width: 100%;
        padding: 12px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .json-output {
        width: 100%;
        height: 150px;
        margin-top: 8px;
        padding: 8px;
        border: 1px solid #d0d0d0;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 10px;
        display: none;
        resize: vertical;
      }

      .json-output.show {
        display: block;
      }

      /* BATTING SPECIFIC */

      #substituteInningEntry {
        display: none;
      }

      #substituteInningEntry.show {
        display: block;
      }

      .role-container.with-substitute {
        grid-template-columns: 1fr 1fr;
      }

      .risp-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: #fff3e0;
        border-left: 3px solid #ff9800;
        border-radius: 4px;
        margin-bottom: 12px;
        cursor: pointer;
      }

      .risp-indicator input[type='checkbox'] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .outcome-btn {
        padding: 10px;
        margin: 5px;
        background: #f8f9fa;
        border: 2px solid #667eea;
        color: #000000;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        margin-bottom: 8px;
      }

      .outcome-btn:active {
        transform: scale(0.95);
      }

      .simple-counter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .simple-counter-item {
        border: 2px solid #000;
        background: #f8f9fa;
        border-radius: 6px;
        padding: 8px;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Password Protection Screen -->
    <div
      id="passwordScreen"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f5f5f5;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          max-width: 400px;
          width: 90%;
        "
      >
        <h2 style="text-align: center; color: #333; margin-bottom: 20px">
          ‚öæ Tracker Access - DEV
        </h2>
        <input
          type="password"
          id="passwordInput"
          placeholder="Enter password"
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 15px;
          "
        />
        <button
          onclick="checkPassword()"
          style="
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
          "
        >
          Unlock
        </button>
        <div
          id="passwordError"
          style="
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            display: none;
          "
        >
          Incorrect password
        </div>
      </div>
    </div>

    <div class="container" id="mainApp" style="display: none">
      <div class="header">
        <h1>PLAYMAKER TRACKER - DEV</h1>
      </div>

      <div class="section-1">
        <input type="date" id="gameDate" />
        <input
          type="text"
          id="opponent"
          placeholder="Opponent"
          onchange="saveGameState()"
        />
      </div>

      <div class="section-2-1">
        <div class="tab active" onclick="switchTab('pitching')">PITCHING</div>
        <div class="tab" onclick="switchTab('batting')">BATTING</div>
        <div class="tab" onclick="switchTab('fielding')">FIELDING</div>
      </div>

      <!-- PITCHING TAB -->
      <div id="pitchingTab" class="tab-content active">
        <div style="margin-bottom: 12px">
          <div class="section-label">Role</div>
          <div class="role-container" id="roleContainer">
            <select id="pitchingRole" onchange="handleRoleChange()">
              <option value="Starter">Starter</option>
              <option value="Relief">Relief</option>
            </select>
            <div id="reliefInningEntry">
              <input
                type="number"
                id="reliefInning"
                placeholder="Inning entered (e.g., 2.1)"
                step="0.1"
                min="0"
              />
            </div>
          </div>
        </div>

        <div
          style="
            padding: 8px;
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            border-radius: 4px;
            font-size: 12px;
            color: #e65100;
            margin-bottom: 12px;
          "
        >
          ‚ö†Ô∏è <strong>Remember:</strong> Track any fielding plays made while
          pitching in the <strong>Fielding</strong> tab!
        </div>

        <div style="margin-bottom: 12px">
          <div class="section-label">Tracking Options</div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackPitchTypes')"
          >
            <input
              type="checkbox"
              id="trackPitchTypes"
              onclick="
                event.stopPropagation();
                togglePitchTypes();
              "
            />
            <label for="trackPitchTypes">Track pitch types</label>
          </div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackBatterActions')"
          >
            <input
              type="checkbox"
              id="trackBatterActions"
              onclick="event.stopPropagation()"
            />
            <label for="trackBatterActions"
              >Track batter actions on strikes</label
            >
          </div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackVelocity')"
          >
            <input
              type="checkbox"
              id="trackVelocity"
              onclick="event.stopPropagation()"
            />
            <label for="trackVelocity">Track velocity</label>
          </div>
        </div>

        <div style="margin: 12px 0">
          <div class="section-label">Count</div>
          <div class="counters-grid">
            <div class="counter-wrapper strike-wrapper">
              <div class="counter-label">STRIKES</div>
              <div class="counter-controls">
                <div class="counter-btn minus" onclick="minusStrike()">‚àí</div>
                <div class="counter-display" id="strikeCounter">0</div>
                <div class="counter-btn plus" onclick="plusStrike()">+</div>
              </div>
            </div>
            <div class="counter-wrapper ball-wrapper">
              <div class="counter-label">BALLS</div>
              <div class="counter-controls">
                <div class="counter-btn minus" onclick="minusBall()">‚àí</div>
                <div class="counter-display" id="ballCounter">0</div>
                <div class="counter-btn plus" onclick="plusBall()">+</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin: 12px 0">
          <div class="section-label">Additional Events</div>
          <div class="events-grid">
            <div class="event-item">
              <div class="event-label">WILD PITCH</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusWildPitch()">‚àí</div>
                <div class="event-display" id="wildPitchDisplay">0</div>
                <div class="event-btn" onclick="addWildPitch()">+</div>
              </div>
            </div>
            <div class="event-item">
              <div class="event-label">BALK</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusBalk()">‚àí</div>
                <div class="event-display" id="balkDisplay">0</div>
                <div class="event-btn" onclick="adjustEvent('balks', 1)">+</div>
              </div>
            </div>
            <div class="event-item">
              <div class="event-label">PICKOFFS</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusPickoff()">‚àí</div>
                <div class="event-display" id="pickoffDisplay">0</div>
                <div class="event-btn" onclick="adjustEvent('pickoffs', 1)">
                  +
                </div>
              </div>
            </div>
          </div>
        </div>

        <button class="ball-in-play-btn" onclick="startBallInPlay()">
          BALL IN PLAY
        </button>

        <div class="runs-grid">
          <div class="run-item runs">
            <div class="event-label">RUNS</div>
            <div class="event-controls">
              <div class="event-btn" onclick="minusRun()">‚àí</div>
              <div class="event-display" id="runsDisplay">0</div>
              <div class="event-btn" onclick="adjustEvent('runs', 1)">+</div>
            </div>
          </div>
          <div class="run-item earned-runs">
            <div class="event-label">EARNED RUNS</div>
            <div class="event-controls">
              <div class="event-btn" onclick="minusEarnedRun()">‚àí</div>
              <div class="event-display" id="earnedRunsDisplay">0</div>
              <div class="event-btn" onclick="adjustEvent('earnedRuns', 1)">
                +
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BATTING TAB -->
      <div id="battingTab" class="tab-content">
        <div style="margin-bottom: 12px">
          <div class="section-label">Status</div>
          <div class="role-container" id="battingStatusContainer">
            <select id="battingStatus" onchange="handleBattingStatusChange()">
              <option value="Starting">Starting</option>
              <option value="Substitute">Substitute</option>
            </select>
            <div id="substituteInningEntry">
              <input
                type="number"
                id="substituteInning"
                placeholder="Inning subbed"
                min="1"
                max="9"
                step="1"
              />
            </div>
          </div>
        </div>

        <div style="margin-bottom: 12px">
          <div class="section-label">Tracking Options</div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackBattingCount')"
          >
            <input
              type="checkbox"
              id="trackBattingCount"
              onclick="event.stopPropagation()"
            />
            <label for="trackBattingCount">Track balls & strikes</label>
          </div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackHitTypes')"
          >
            <input
              type="checkbox"
              id="trackHitTypes"
              onclick="event.stopPropagation()"
            />
            <label for="trackHitTypes">Track hit types</label>
          </div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackHitLocation')"
          >
            <input
              type="checkbox"
              id="trackHitLocation"
              onclick="event.stopPropagation()"
            />
            <label for="trackHitLocation">Track hit location</label>
          </div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackStrikeoutType')"
          >
            <input
              type="checkbox"
              id="trackStrikeoutType"
              onclick="event.stopPropagation()"
            />
            <label for="trackStrikeoutType"
              >Track strikeout type (K-L vs K-S)</label
            >
          </div>
        </div>

        <!-- RISP Indicator -->
        <div class="risp-indicator">
          <input type="checkbox" id="runnersInScoring" />
          <label
            for="runnersInScoring"
            style="font-weight: 600; cursor: pointer"
          >
            Runners in scoring position
          </label>
        </div>

        <!-- Count Section (if tracking) -->
        <div class="hidden" id="battingCountSection" style="margin: 12px 0">
          <div class="section-label">Count</div>
          <div class="counters-grid">
            <div class="counter-wrapper strike-wrapper">
              <div class="counter-label">STRIKES</div>
              <div class="counter-controls">
                <div class="counter-btn minus" onclick="minusBattingStrike()">
                  ‚àí
                </div>
                <div class="counter-display" id="battingStrikeCounter">0</div>
                <div class="counter-btn plus" onclick="plusBattingStrike()">
                  +
                </div>
              </div>
            </div>
            <div class="counter-wrapper ball-wrapper">
              <div class="counter-label">BALLS</div>
              <div class="counter-controls">
                <div class="counter-btn minus" onclick="minusBattingBall()">
                  ‚àí
                </div>
                <div class="counter-display" id="battingBallCounter">0</div>
                <div class="counter-btn plus" onclick="plusBattingBall()">
                  +
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Manual Outcomes (when NOT tracking count OR ball 4) -->
        <div style="margin: 12px 0">
          <div class="section-label">At Bat Outcome</div>
          <div
            class="outcome-buttons show"
            style="display: grid; grid-template-columns: 1fr 1fr"
          >
            <div
              class="outcome-btn"
              id="manualStrikeoutBtn"
              onclick="recordBattingOutcome('k')"
            >
              STRIKEOUT
            </div>
            <div
              class="outcome-btn"
              id="manualWalkBtn"
              onclick="recordBattingOutcome('bb')"
            >
              WALK
            </div>
            <div class="outcome-btn" onclick="recordBattingOutcome('hbp')">
              HIT BY PITCH
            </div>
            <div class="outcome-btn" onclick="recordBattingOutcome('ci')">
              CATCHER'S INT
            </div>
          </div>
        </div>

        <!-- Ball in Play Button -->
        <button class="ball-in-play-btn" onclick="startBattingBallInPlay()">
          BALL IN PLAY
        </button>

        <!-- Baserunning Counters -->
        <div style="margin: 12px 0">
          <div class="section-label">Baserunning</div>
          <div class="simple-counter-grid">
            <div class="simple-counter-item">
              <div class="event-label">RBI</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusRBI()">‚àí</div>
                <div class="event-display" id="rbiDisplay">0</div>
                <div class="event-btn" onclick="adjustBattingEvent('rbi', 1)">
                  +
                </div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">SB</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusSB()">‚àí</div>
                <div class="event-display" id="sbDisplay">0</div>
                <div class="event-btn" onclick="adjustBattingEvent('sb', 1)">
                  +
                </div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">CS</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusCS()">‚àí</div>
                <div class="event-display" id="csDisplay">0</div>
                <div class="event-btn" onclick="adjustBattingEvent('cs', 1)">
                  +
                </div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">PICKED OFF</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusPickedOff()">‚àí</div>
                <div class="event-display" id="pickedOffDisplay">0</div>
                <div
                  class="event-btn"
                  onclick="adjustBattingEvent('pickedOff', 1)"
                >
                  +
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FIELDING TAB -->
      <div id="fieldingTab" class="tab-content">
        <div style="margin-bottom: 12px">
          <div class="section-label">Active Position</div>
          <div
            id="activePositionDisplay"
            style="
              padding: 12px;
              background: #e3f2fd;
              border-left: 3px solid #2196f3;
              border-radius: 4px;
              margin-bottom: 8px;
              font-weight: 600;
              color: #1976d2;
              text-align: center;
            "
          >
            No position selected
          </div>
          <button
            class="outcome-btn"
            onclick="showSelectPositionModal()"
            style="width: 100%; padding: 12px; font-size: 14px"
          >
            SELECT POSITION
          </button>
        </div>

        <div style="margin-bottom: 12px">
          <div class="section-label">Positions Played This Game</div>
          <div id="positionsPlayedList" style="margin-bottom: 8px">
            <div
              style="
                padding: 8px;
                text-align: center;
                color: #999;
                font-size: 12px;
                font-style: italic;
              "
            >
              No positions recorded yet
            </div>
          </div>
        </div>

        <div style="margin-bottom: 12px">
          <div class="section-label">Tracking Options</div>
          <div
            class="checkbox-option"
            onclick="toggleCheckbox('trackPlayTypes')"
          >
            <input
              type="checkbox"
              id="trackPlayTypes"
              onclick="event.stopPropagation()"
            />
            <label for="trackPlayTypes"
              >Track play types (Fly Ball, Ground Ball, etc.)</label
            >
          </div>
        </div>

        <!-- Fielding Counters -->
        <div style="margin: 12px 0">
          <div class="section-label">Fielding Stats (Current Position)</div>
          <div
            class="simple-counter-grid"
            style="grid-template-columns: 1fr 1fr"
          >
            <div class="simple-counter-item">
              <div class="event-label">PUTOUTS (PO)</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusPutout()">‚àí</div>
                <div class="event-display" id="putoutsDisplay">0</div>
                <div class="event-btn" onclick="addPutout()">+</div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">ASSISTS (A)</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusAssist()">‚àí</div>
                <div class="event-display" id="assistsDisplay">0</div>
                <div class="event-btn" onclick="addAssist()">+</div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">ERRORS (E)</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusError()">‚àí</div>
                <div class="event-display" id="errorsDisplay">0</div>
                <div
                  class="event-btn"
                  onclick="adjustFieldingEvent('errors', 1)"
                >
                  +
                </div>
              </div>
            </div>
            <div class="simple-counter-item">
              <div class="event-label">DOUBLE PLAYS (DP)</div>
              <div class="event-controls">
                <div class="event-btn" onclick="minusDP()">‚àí</div>
                <div class="event-display" id="dpDisplay">0</div>
                <div class="event-btn" onclick="adjustFieldingEvent('dp', 1)">
                  +
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SECTION 3: Stats -->
      <div class="section-3">
        <div class="section-3-title">üìä STATS</div>

        <!-- Pitching Stats -->
        <div class="section-3-1" id="pitchingStatsSection">
          <div class="section-3-2-title">Pitching</div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">IP</div>
              <div class="stat-value" id="ipStat">0.0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Pitches</div>
              <div class="stat-value" id="pitchCountStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">K</div>
              <div class="stat-value" id="kStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">BB</div>
              <div class="stat-value" id="bbStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">H</div>
              <div class="stat-value" id="hStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">R</div>
              <div class="stat-value" id="rStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">ER</div>
              <div class="stat-value" id="erStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">WP</div>
              <div class="stat-value" id="wpStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Balks</div>
              <div class="stat-value" id="balksStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Pickoffs</div>
              <div class="stat-value" id="pickoffsStat">0</div>
            </div>
          </div>
        </div>

        <!-- Batting Stats -->
        <div class="section-3-1 hidden" id="battingStatsSection">
          <div class="section-3-2-title">Batting</div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">PA</div>
              <div class="stat-value" id="battingPAStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">AB</div>
              <div class="stat-value" id="battingABStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">H</div>
              <div class="stat-value" id="battingHStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">2B</div>
              <div class="stat-value" id="batting2BStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">3B</div>
              <div class="stat-value" id="batting3BStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HR</div>
              <div class="stat-value" id="battingHRStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">RBI</div>
              <div class="stat-value" id="battingRBIStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">BB</div>
              <div class="stat-value" id="battingBBStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">K</div>
              <div class="stat-value" id="battingKStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">AVG</div>
              <div class="stat-value" id="battingAVGStat">.000</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">OBP</div>
              <div class="stat-value" id="battingOBPStat">.000</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">SLG</div>
              <div class="stat-value" id="battingSLGStat">.000</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">OPS</div>
              <div class="stat-value" id="battingOPSStat">.000</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">BABIP</div>
              <div class="stat-value" id="battingBABIPStat">.000</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">TB</div>
              <div class="stat-value" id="battingTBStat">0</div>
            </div>
          </div>
        </div>

        <!-- Fielding Stats -->
        <div class="section-3-1 hidden" id="fieldingStatsSection">
          <div class="section-3-2-title">Fielding</div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">PO</div>
              <div class="stat-value" id="fieldingPOStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">A</div>
              <div class="stat-value" id="fieldingAStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">E</div>
              <div class="stat-value" id="fieldingEStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">DP</div>
              <div class="stat-value" id="fieldingDPStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">TC</div>
              <div class="stat-value" id="fieldingTCStat">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">FLD%</div>
              <div class="stat-value" id="fieldingPctStat">.000</div>
            </div>
          </div>
        </div>

        <!-- Pitch Type Stats -->
        <div class="section-3-2" id="pitchTypeStatsSection">
          <div class="section-3-2-title">Pitch Type Analysis</div>
          <div id="pitchTypeStatsContent">
            <div class="pitch-type-stat">No pitch data yet</div>
          </div>
        </div>

        <!-- Export -->
        <div class="section-3-3">
          <div class="export-btn" onclick="exportGameData()">EXPORT DATA</div>
          <div class="reset-btn" onclick="resetAll()">RESET ALL DATA</div>
        </div>
      </div>
    </div>

    <!-- Action History Button (Fixed at bottom) -->
    <button
      class="action-history-btn hidden"
      id="actionHistoryBtn"
      onclick="showActionHistoryModal()"
    >
      üìã ACTION HISTORY
    </button>

    <!-- MODALS -->

    <!-- Pitch Type Modal -->
    <div class="modal-overlay" id="pitchTypeModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Select Pitch Type</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button class="modal-button" onclick="selectPitchTypeModal('FB')">
              FB
            </button>
            <button class="modal-button" onclick="selectPitchTypeModal('CB')">
              CB
            </button>
            <button class="modal-button" onclick="selectPitchTypeModal('SL')">
              SL
            </button>
            <button class="modal-button" onclick="selectPitchTypeModal('CU')">
              CU
            </button>
          </div>
          <div style="margin-top: 10px">
            <input
              type="text"
              id="otherPitchTypeInput"
              placeholder="Other pitch type..."
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
                margin-bottom: 10px;
              "
            />
            <button
              class="modal-button"
              onclick="selectPitchTypeModal('OTHER')"
              style="width: 100%"
            >
              OTHER
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="selectPitchTypeModal('SKIP')"
          >
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelPitchTypeModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Batter Actions Modal -->
    <div class="modal-overlay" id="batterActionsModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Strike Action</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button"
              onclick="handleBatterActionModal('swinging')"
            >
              SWINGING
            </button>
            <button
              class="modal-button"
              onclick="handleBatterActionModal('looking')"
            >
              LOOKING
            </button>
            <button
              class="modal-button"
              onclick="handleBatterActionModal('foul')"
            >
              FOUL
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="handleBatterActionModal('SKIP')"
          >
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelBatterActionsModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Hit Type Modal -->
    <div class="modal-overlay" id="hitTypeModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Hit Type</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button hit-type"
              onclick="selectHitType('popfly')"
            >
              POP FLY
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectHitType('groundball')"
            >
              GROUND BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectHitType('flyball')"
            >
              FLY BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectHitType('linedrive')"
            >
              LINE DRIVE
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectHitType('bunt')"
            >
              BUNT
            </button>
          </div>
          <button class="modal-button skip" onclick="selectHitType('SKIP')">
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelHitTypeModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Ball in Play Outcome Modal -->
    <div class="modal-overlay" id="ballInPlayModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Ball in Play Outcome</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button outcome out"
              onclick="recordBallInPlay('out')"
            >
              OUT
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBallInPlay('single')"
            >
              SINGLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBallInPlay('double')"
            >
              DOUBLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBallInPlay('triple')"
            >
              TRIPLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBallInPlay('hr')"
            >
              HOME RUN
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBallInPlay('error')"
            >
              ERROR
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="cancelBallInPlayModal()"
            style="background: #ffebee; color: #c62828"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Velocity Modal -->
    <div class="modal-overlay" id="velocityModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Pitch Velocity</div>
        </div>
        <div class="modal-body">
          <input
            type="number"
            id="velocityModalInput"
            class="velocity-modal-input"
            placeholder="Enter MPH (50-110)"
            min="50"
            max="110"
          />
          <button
            class="modal-button"
            onclick="submitVelocity()"
            style="width: 100%; margin-bottom: 10px"
          >
            SUBMIT
          </button>
          <button class="modal-button skip" onclick="skipVelocity()">
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelVelocityModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Action Modal -->
    <div class="modal-overlay" id="editActionModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Edit Action</div>
          <button class="modal-close" onclick="closeEditActionModal()">
            √ó
          </button>
        </div>
        <div class="modal-body" id="editActionModalBody">
          <!-- Content will be dynamically generated -->
        </div>
      </div>
    </div>

    <!-- BATTING MODALS -->

    <!-- Batting Hit Type Modal -->
    <div class="modal-overlay" id="battingHitTypeModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Hit Type</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitType('popfly')"
            >
              POP FLY
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitType('groundball')"
            >
              GROUND BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitType('flyball')"
            >
              FLY BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitType('linedrive')"
            >
              LINE DRIVE
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitType('bunt')"
            >
              BUNT
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="selectBattingHitType('SKIP')"
          >
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelBattingHitTypeModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Batting Hit Location Modal -->
    <div class="modal-overlay" id="battingHitLocationModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Hit Location</div>
        </div>
        <div class="modal-body">
          <div
            style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 10px;
            "
          >
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('P')"
            >
              P
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('C')"
            >
              C
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('1B')"
            >
              1B
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('2B')"
            >
              2B
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('3B')"
            >
              3B
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('SS')"
            >
              SS
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('LF')"
            >
              LF
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('CF')"
            >
              CF
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('RF')"
            >
              RF
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('LC')"
            >
              LC GAP
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectBattingHitLocation('RC')"
            >
              RC GAP
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="selectBattingHitLocation('SKIP')"
          >
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelBattingHitLocationModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Batting Ball in Play Outcome Modal -->
    <div class="modal-overlay" id="battingBallInPlayModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Ball in Play Outcome</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('single')"
            >
              SINGLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('double')"
            >
              DOUBLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('triple')"
            >
              TRIPLE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('hr')"
            >
              HOME RUN
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('iphr')"
            >
              IPHR
            </button>
            <button
              class="modal-button outcome out"
              onclick="recordBattingBallInPlay('out')"
            >
              OUT
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('roe')"
            >
              REACH ON ERROR
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('fc')"
            >
              FIELDER'S CHOICE
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('sh')"
            >
              SAC BUNT
            </button>
            <button
              class="modal-button outcome"
              onclick="recordBattingBallInPlay('sf')"
            >
              SAC FLY
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Batting Strikeout Type Modal -->
    <div class="modal-overlay" id="battingStrikeoutTypeModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Strikeout Type</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button"
              onclick="selectBattingStrikeoutType('looking')"
            >
              LOOKING
            </button>
            <button
              class="modal-button"
              onclick="selectBattingStrikeoutType('swinging')"
            >
              SWINGING
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="selectBattingStrikeoutType('SKIP')"
          >
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelBattingStrikeoutTypeModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Strike 3 Outcome Modal -->
    <div class="modal-overlay" id="strike3Modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Strike 3 Outcome</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid" style="grid-template-columns: 1fr">
            <button class="modal-button" onclick="recordStrike3Outcome('k')">
              STRIKEOUT
            </button>
            <button
              class="modal-button"
              onclick="recordStrike3Outcome('d3k_reached')"
            >
              DROPPED 3RD K (REACHED)
            </button>
            <button
              class="modal-button"
              onclick="recordStrike3Outcome('d3k_out')"
            >
              DROPPED 3RD K (OUT)
            </button>
          </div>
          <button
            class="modal-button skip"
            onclick="cancelStrike3Modal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- RBI Modal -->
    <div class="modal-overlay" id="rbiModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title" id="rbiModalTitle">Runs Scored?</div>
        </div>
        <div class="modal-body">
          <div id="rbiModalContent">
            <!-- Content will be dynamically generated -->
          </div>
        </div>
      </div>
    </div>

    <!-- FIELDING MODALS -->

    <!-- Select Position Modal -->
    <div class="modal-overlay" id="selectPositionModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Select Active Position</div>
          <button class="modal-close" onclick="closeSelectPositionModal()">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom: 12px">
            <div class="section-label">Position</div>
            <select
              id="positionSelect"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #d0d0d0;
                border-radius: 6px;
              "
            >
              <option value="P">Pitcher (P)</option>
              <option value="C">Catcher (C)</option>
              <option value="1B">First Base (1B)</option>
              <option value="2B">Second Base (2B)</option>
              <option value="3B">Third Base (3B)</option>
              <option value="SS">Shortstop (SS)</option>
              <option value="LF">Left Field (LF)</option>
              <option value="CF">Center Field (CF)</option>
              <option value="RF">Right Field (RF)</option>
              <option value="DH">Designated Hitter (DH)</option>
            </select>
          </div>
          <button
            class="modal-button"
            onclick="setActivePosition()"
            style="width: 100%"
          >
            SET ACTIVE POSITION
          </button>
        </div>
      </div>
    </div>

    <!-- Play Type Modal -->
    <div class="modal-overlay" id="playTypeModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Play Type</div>
        </div>
        <div class="modal-body">
          <div class="modal-button-grid">
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('flyball')"
            >
              FLY BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('groundball')"
            >
              GROUND BALL
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('linedrive')"
            >
              LINE DRIVE
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('tag')"
            >
              TAG
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('forceout')"
            >
              FORCE OUT
            </button>
            <button
              class="modal-button hit-type"
              onclick="selectPlayType('other')"
            >
              OTHER
            </button>
          </div>
          <button class="modal-button skip" onclick="selectPlayType('SKIP')">
            SKIP
          </button>
          <button
            class="modal-button skip"
            onclick="cancelPlayTypeModal()"
            style="background: #ffebee; color: #c62828; margin-top: 5px"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>

    <!-- Action History Modal -->
    <div class="modal-overlay" id="actionHistoryModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Pitching Actions</div>
          <button class="modal-close" onclick="closeActionHistoryModal()">
            √ó
          </button>
        </div>
        <div class="modal-body">
          <div class="action-list" id="actionHistoryList">
            <div class="empty-history">No actions yet</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Set today's date
      document.getElementById('gameDate').valueAsDate = new Date();

      // Game state
      let gameState = {
        gameDate: null,
        opponent: null,
        pitching: {
          strikeCounter: 0,
          ballCounter: 0,
          stats: {
            ip: 0,
            outs: 0,
            pitchCount: 0,
            strikeouts: 0,
            walks: 0,
            hits: 0,
            runs: 0,
            earnedRuns: 0,
            wildPitches: 0,
            balks: 0,
            pickoffs: 0,
          },
          velocities: [],
          actions: [], // Track all actions for history
        },
        batting: {
          strikeCounter: 0,
          ballCounter: 0,
          stats: {
            pa: 0,
            ab: 0,
            h: 0,
            singles: 0,
            doubles: 0,
            triples: 0,
            hr: 0,
            iphr: 0,
            rbi: 0,
            bb: 0,
            hbp: 0,
            k: 0,
            kLooking: 0,
            kSwinging: 0,
            sb: 0,
            cs: 0,
            pickedOff: 0,
            sf: 0,
            sh: 0,
            roe: 0,
            fc: 0,
            d3k_reached: 0,
            d3k_out: 0,
            ci: 0,
            ab_risp: 0,
            h_risp: 0,
            rbi_risp: 0,
          },
          actions: [],
        },
        fielding: {
          positions: {},
          stats: {
            po: 0,
            assists: 0,
            errors: 0,
            dp: 0,
          },
          actions: [],
        },
      };

      // Pending action state
      let pendingAction = {
        type: null, // 'strike', 'ball', 'ballInPlay', 'wildPitch'
        pitchType: null,
        batterAction: null,
        hitType: null,
        outcome: null,
      };

      // Auto-save to localStorage
      function saveGameState() {
        // Capture current form values
        gameState.gameDate = document.getElementById('gameDate').value;
        gameState.opponent = document.getElementById('opponent').value;

        // Save checkbox states
        gameState.checkboxes = {
          trackPitchTypes: document.getElementById('trackPitchTypes').checked,
          trackBatterActions:
            document.getElementById('trackBatterActions').checked,
          trackVelocity: document.getElementById('trackVelocity').checked,
          trackBattingCount:
            document.getElementById('trackBattingCount').checked,
          trackHitTypes: document.getElementById('trackHitTypes').checked,
          trackHitLocation: document.getElementById('trackHitLocation').checked,
          trackStrikeoutType:
            document.getElementById('trackStrikeoutType').checked,
          trackPlayTypes: document.getElementById('trackPlayTypes').checked,
        };

        localStorage.setItem('currentGameDev', JSON.stringify(gameState));
      }

      // Load from localStorage
      function loadGameState() {
        const saved = localStorage.getItem('currentGameDev');
        if (saved) {
          gameState = JSON.parse(saved);

          // Initialize missing structures (for backward compatibility)
          if (!gameState.fielding || !gameState.fielding.positions) {
            gameState.fielding = {
              positions: {},
              actions: [],
            };
          }
          // Convert old array format to object format
          if (Array.isArray(gameState.fielding.positions)) {
            gameState.fielding.positions = {};
          }

          // Restore form fields
          if (gameState.gameDate) {
            document.getElementById('gameDate').value = gameState.gameDate;
          }
          if (gameState.opponent) {
            document.getElementById('opponent').value = gameState.opponent;
          }

          // Restore checkbox states
          if (gameState.checkboxes) {
            document.getElementById('trackPitchTypes').checked =
              gameState.checkboxes.trackPitchTypes || false;
            document.getElementById('trackBatterActions').checked =
              gameState.checkboxes.trackBatterActions || false;
            document.getElementById('trackVelocity').checked =
              gameState.checkboxes.trackVelocity || false;
            document.getElementById('trackBattingCount').checked =
              gameState.checkboxes.trackBattingCount || false;
            document.getElementById('trackHitTypes').checked =
              gameState.checkboxes.trackHitTypes || false;
            document.getElementById('trackHitLocation').checked =
              gameState.checkboxes.trackHitLocation || false;
            document.getElementById('trackStrikeoutType').checked =
              gameState.checkboxes.trackStrikeoutType || false;
            document.getElementById('trackPlayTypes').checked =
              gameState.checkboxes.trackPlayTypes || false;

            // Trigger visibility updates for dependent UI elements
            if (gameState.checkboxes.trackPitchTypes) {
              document
                .getElementById('pitchTypeStatsSection')
                .classList.add('show');
            }
            if (gameState.checkboxes.trackBattingCount) {
              document
                .getElementById('battingCountSection')
                .classList.remove('hidden');
              const manualKBtn = document.getElementById('manualStrikeoutBtn');
              const manualBBBtn = document.getElementById('manualWalkBtn');
              if (manualKBtn) manualKBtn.style.display = 'none';
              if (manualBBBtn) manualBBBtn.style.display = 'none';
            }
          }

          updatePitchingDisplay();
          updatePitchTypeStats();
          updateBattingDisplay();
          updateFieldingDisplay();
          updatePositionsPlayedList();

          // Show action history button if there are actions
          if (
            gameState.pitching.actions.length > 0 ||
            gameState.batting.actions.length > 0
          ) {
            document
              .getElementById('actionHistoryBtn')
              .classList.remove('hidden');
          }
        }
      }

      // Clear saved game
      function clearSavedGame() {
        localStorage.removeItem('currentGameDev');
      }

      // ==========================================
      // TAB SWITCHING
      // ==========================================

      function switchTab(tab) {
        document
          .querySelectorAll('.tab')
          .forEach((t) => t.classList.remove('active'));
        document
          .querySelectorAll('.tab-content')
          .forEach((c) => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(tab + 'Tab').classList.add('active');

        // Show/hide stats sections based on tab
        const pitchingStatsSection = document.getElementById(
          'pitchingStatsSection'
        );
        const battingStatsSection = document.getElementById(
          'battingStatsSection'
        );
        const fieldingStatsSection = document.getElementById(
          'fieldingStatsSection'
        );
        const pitchTypeStatsSection = document.getElementById(
          'pitchTypeStatsSection'
        );

        if (tab === 'pitching') {
          pitchingStatsSection.classList.remove('hidden');
          battingStatsSection.classList.add('hidden');
          fieldingStatsSection.classList.add('hidden');
          // Pitch type stats only show if tracking is enabled
          const trackPitchTypes =
            document.getElementById('trackPitchTypes').checked;
          if (trackPitchTypes) {
            pitchTypeStatsSection.classList.add('show');
          } else {
            pitchTypeStatsSection.classList.remove('show');
          }
        } else if (tab === 'batting') {
          pitchingStatsSection.classList.add('hidden');
          battingStatsSection.classList.remove('hidden');
          fieldingStatsSection.classList.add('hidden');
          pitchTypeStatsSection.classList.remove('show');
        } else if (tab === 'fielding') {
          pitchingStatsSection.classList.add('hidden');
          battingStatsSection.classList.add('hidden');
          fieldingStatsSection.classList.remove('hidden');
          pitchTypeStatsSection.classList.remove('show');
        } else {
          pitchingStatsSection.classList.add('hidden');
          battingStatsSection.classList.add('hidden');
          fieldingStatsSection.classList.add('hidden');
          pitchTypeStatsSection.classList.remove('show');
        }

        // Show/hide action history button based on tab
        const historyBtn = document.getElementById('actionHistoryBtn');
        if (tab === 'pitching' && gameState.pitching.actions.length > 0) {
          historyBtn.classList.remove('hidden');
        } else if (tab === 'batting' && gameState.batting.actions.length > 0) {
          historyBtn.classList.remove('hidden');
        } else if (
          tab === 'fielding' &&
          gameState.fielding.actions.length > 0
        ) {
          historyBtn.classList.remove('hidden');
        } else {
          historyBtn.classList.add('hidden');
        }
      }

      // ==========================================
      // CHECKBOX HELPERS
      // ==========================================

      function toggleCheckbox(id) {
        const checkbox = document.getElementById(id);
        checkbox.checked = !checkbox.checked;
        if (id === 'trackPitchTypes') {
          togglePitchTypes();
        }
      }

      function togglePitchTypes() {
        const checked = document.getElementById('trackPitchTypes').checked;
        const statsSection = document.getElementById('pitchTypeStatsSection');

        if (checked) {
          statsSection.classList.add('show');
        } else {
          statsSection.classList.remove('show');
        }
      }

      // ==========================================
      // ROLE CHANGE
      // ==========================================

      function handleRoleChange() {
        const role = document.getElementById('pitchingRole').value;
        const reliefEntry = document.getElementById('reliefInningEntry');
        const container = document.getElementById('roleContainer');

        if (role === 'Relief') {
          container.classList.add('with-relief');
          reliefEntry.classList.add('show');
        } else {
          container.classList.remove('with-relief');
          reliefEntry.classList.remove('show');
        }
      }

      // ==========================================
      // STRIKE BUTTON
      // ==========================================

      function plusStrike() {
        const trackPitchTypes =
          document.getElementById('trackPitchTypes').checked;

        pendingAction = {
          type: 'strike',
          pitchType: null,
          batterAction: null,
        };

        // If tracking pitch types, show pitch type modal first
        if (trackPitchTypes) {
          showPitchTypeModal();
        } else {
          // Otherwise, check if tracking batter actions
          const trackBatterActions =
            document.getElementById('trackBatterActions').checked;
          if (trackBatterActions) {
            showBatterActionsModal();
          } else {
            // Process strike immediately
            processStrike(null, null);
          }
        }
      }

      function minusStrike() {
        // Find the most recent strike action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'strike') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      // ==========================================
      // BALL BUTTON
      // ==========================================

      function plusBall() {
        const trackPitchTypes =
          document.getElementById('trackPitchTypes').checked;

        pendingAction = {
          type: 'ball',
          pitchType: null,
          batterAction: null,
        };

        // If tracking pitch types, show pitch type modal first
        if (trackPitchTypes) {
          showPitchTypeModal();
        } else {
          // Process ball immediately
          processBall(null);
        }
      }

      function minusBall() {
        // Find the most recent ball or wildPitch action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (
            gameState.pitching.actions[i].type === 'ball' ||
            gameState.pitching.actions[i].type === 'wildPitch'
          ) {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      function minusWildPitch() {
        // Find the most recent wildPitch action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'wildPitch') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      function minusBalk() {
        // Find the most recent balk action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'balks') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      function minusPickoff() {
        // Find the most recent pickoff action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'pickoffs') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      function minusRun() {
        // Find the most recent run action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'runs') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      function minusEarnedRun() {
        // Find the most recent earned run action
        for (let i = gameState.pitching.actions.length - 1; i >= 0; i--) {
          if (gameState.pitching.actions[i].type === 'earnedRuns') {
            // Remove this action
            gameState.pitching.actions.splice(i, 1);

            // Recalculate everything
            recalculateCurrentCount();
            recalculateStatsFromActions();
            updatePitchingDisplay();
            updatePitchTypeStats();
            saveGameState();

            // Hide action history button if no actions left
            if (gameState.pitching.actions.length === 0) {
              document
                .getElementById('actionHistoryBtn')
                .classList.add('hidden');
            }

            return;
          }
        }
      }

      // ==========================================
      // WILD PITCH
      // ==========================================

      function addWildPitch() {
        const trackPitchTypes =
          document.getElementById('trackPitchTypes').checked;

        pendingAction = {
          type: 'wildPitch',
          pitchType: null,
        };

        // If tracking pitch types, show pitch type modal first
        if (trackPitchTypes) {
          showPitchTypeModal();
        } else {
          // Process wild pitch immediately
          processWildPitch(null);
        }
      }

      function processWildPitch(pitchType) {
        // Add wild pitch
        gameState.pitching.stats.wildPitches++;

        // Auto-add ball
        gameState.pitching.ballCounter++;
        gameState.pitching.stats.pitchCount++;

        // Record action
        addAction('wildPitch', null, pitchType);

        // Check for walk
        if (gameState.pitching.ballCounter >= 4) {
          gameState.pitching.stats.walks++;
          resetCounters();
        }

        updatePitchingDisplay();
        updatePitchTypeStats();

        // Check if tracking velocity
        const trackVelocity = document.getElementById('trackVelocity').checked;
        if (trackVelocity) {
          showVelocityModal();
        } else {
          saveGameState();
          pendingAction = { type: null, pitchType: null };
        }
      }

      // ==========================================
      // PITCH TYPE MODAL
      // ==========================================

      function showPitchTypeModal() {
        document.getElementById('pitchTypeModal').classList.add('show');
      }

      function selectPitchTypeModal(type) {
        let pitchType = type;

        if (type === 'OTHER') {
          const otherInput = document.getElementById('otherPitchTypeInput');
          pitchType = otherInput.value.trim() || 'OTHER';
          otherInput.value = '';
        } else if (type === 'SKIP') {
          pitchType = null;
        }

        pendingAction.pitchType = pitchType;

        // Close modal
        document.getElementById('pitchTypeModal').classList.remove('show');

        // Continue with the pending action
        if (pendingAction.type === 'strike') {
          const trackBatterActions =
            document.getElementById('trackBatterActions').checked;
          if (trackBatterActions) {
            showBatterActionsModal();
          } else {
            processStrike(pitchType, null);
          }
        } else if (pendingAction.type === 'ball') {
          processBall(pitchType);
        } else if (pendingAction.type === 'wildPitch') {
          processWildPitch(pitchType);
        } else if (pendingAction.type === 'ballInPlay') {
          // Show hit type modal next
          showHitTypeModal();
        }
      }

      // ==========================================
      // BATTER ACTIONS MODAL
      // ==========================================

      function showBatterActionsModal() {
        document.getElementById('batterActionsModal').classList.add('show');
      }

      function handleBatterActionModal(action) {
        // Determine if this is for pitching or batting based on active tab
        const activeTab = document
          .querySelector('.tab.active')
          .textContent.trim();

        if (activeTab === 'PITCHING') {
          selectBatterAction(action);
        } else if (activeTab === 'BATTING') {
          selectBattingStrikeAction(action);
        }
      }

      function selectBatterAction(action) {
        const batterAction = action === 'SKIP' ? null : action;
        pendingAction.batterAction = batterAction;

        // Close modal
        document.getElementById('batterActionsModal').classList.remove('show');

        // Process the strike
        processStrike(pendingAction.pitchType, batterAction);
      }

      // ==========================================
      // PROCESS STRIKE
      // ==========================================

      function processStrike(pitchType, batterAction) {
        // Handle foul with 2 strikes (doesn't increment strike counter)
        if (batterAction === 'foul' && gameState.pitching.strikeCounter >= 2) {
          gameState.pitching.stats.pitchCount++;

          // Record action
          addAction('strike', 'foul', pitchType);
        } else {
          gameState.pitching.strikeCounter++;
          gameState.pitching.stats.pitchCount++;

          // Record action
          addAction('strike', batterAction || 'none', pitchType);

          // Check for strikeout
          if (
            gameState.pitching.strikeCounter >= 3 &&
            (batterAction === 'swinging' ||
              batterAction === 'looking' ||
              batterAction === null)
          ) {
            gameState.pitching.stats.strikeouts++;
            gameState.pitching.stats.outs++;
            resetCounters();
          }
        }

        updatePitchingDisplay();
        updatePitchTypeStats();

        // Check if tracking velocity
        const trackVelocity = document.getElementById('trackVelocity').checked;
        if (trackVelocity) {
          showVelocityModal();
        } else {
          saveGameState();
          pendingAction = { type: null, pitchType: null, batterAction: null };
        }
      }

      // ==========================================
      // PROCESS BALL
      // ==========================================

      function processBall(pitchType) {
        gameState.pitching.ballCounter++;
        gameState.pitching.stats.pitchCount++;

        // Record action
        addAction('ball', null, pitchType);

        // Check for walk
        if (gameState.pitching.ballCounter >= 4) {
          gameState.pitching.stats.walks++;
          resetCounters();
        }

        updatePitchingDisplay();
        updatePitchTypeStats();

        // Check if tracking velocity
        const trackVelocity = document.getElementById('trackVelocity').checked;
        if (trackVelocity) {
          showVelocityModal();
        } else {
          saveGameState();
          pendingAction = { type: null, pitchType: null };
        }
      }

      // ==========================================
      // BALL IN PLAY FLOW
      // ==========================================

      function startBallInPlay() {
        const trackPitchTypes =
          document.getElementById('trackPitchTypes').checked;

        pendingAction = {
          type: 'ballInPlay',
          pitchType: null,
          hitType: null,
          outcome: null,
        };

        // If tracking pitch types, show pitch type modal first
        if (trackPitchTypes) {
          showPitchTypeModal();
        } else {
          // Otherwise, show hit type modal
          showHitTypeModal();
        }
      }

      function showHitTypeModal() {
        document.getElementById('hitTypeModal').classList.add('show');
      }

      function selectHitType(type) {
        const hitType = type === 'SKIP' ? null : type;
        pendingAction.hitType = hitType;

        // Close modal
        document.getElementById('hitTypeModal').classList.remove('show');

        // Show ball in play outcome modal
        showBallInPlayModal();
      }

      function showBallInPlayModal() {
        document.getElementById('ballInPlayModal').classList.add('show');
      }

      function recordBallInPlay(outcome) {
        pendingAction.outcome = outcome;

        // Close modal
        document.getElementById('ballInPlayModal').classList.remove('show');

        // Process the ball in play
        gameState.pitching.stats.pitchCount++;

        // Record action with all details
        addAction(
          'ballInPlay',
          outcome,
          pendingAction.pitchType,
          pendingAction.hitType
        );

        if (outcome === 'out') {
          gameState.pitching.stats.outs++;
        } else if (outcome !== 'error') {
          gameState.pitching.stats.hits++;

          if (outcome === 'hr') {
            gameState.pitching.stats.runs++;
            gameState.pitching.stats.earnedRuns++;
          }
        }

        resetCounters();
        updatePitchingDisplay();
        updatePitchTypeStats();

        // Check if tracking velocity
        const trackVelocity = document.getElementById('trackVelocity').checked;
        if (trackVelocity) {
          showVelocityModal();
        } else {
          saveGameState();
          pendingAction = {
            type: null,
            pitchType: null,
            hitType: null,
            outcome: null,
          };
        }
      }

      // ==========================================
      // VELOCITY MODAL
      // ==========================================

      function showVelocityModal() {
        document.getElementById('velocityModalInput').value = '';
        document.getElementById('velocityModal').classList.add('show');
      }

      function submitVelocity() {
        const input = document.getElementById('velocityModalInput');
        const velo = parseInt(input.value);

        if (velo && velo >= 50 && velo <= 110) {
          gameState.pitching.velocities.push(velo);

          // Update last action with velocity
          if (gameState.pitching.actions.length > 0) {
            gameState.pitching.actions[
              gameState.pitching.actions.length - 1
            ].velocity = velo;
          }

          // Close modal
          document.getElementById('velocityModal').classList.remove('show');
          saveGameState();
          pendingAction = {
            type: null,
            pitchType: null,
            batterAction: null,
            hitType: null,
            outcome: null,
          };
        } else {
          alert('Please enter a velocity between 50-110 MPH');
        }
      }

      function skipVelocity() {
        document.getElementById('velocityModal').classList.remove('show');
        saveGameState();
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
      }

      // ==========================================
      // ADDITIONAL EVENTS
      // ==========================================

      function adjustEvent(stat, delta) {
        gameState.pitching.stats[stat] = Math.max(
          0,
          gameState.pitching.stats[stat] + delta
        );

        // Record action
        if (delta > 0) {
          addAction(stat, 'increment', null);
        }

        updatePitchingDisplay();
        saveGameState();
      }

      // ==========================================
      // ACTION HISTORY
      // ==========================================

      function addAction(type, detail, pitchType, hitType = null) {
        const action = {
          id: Date.now() + Math.random(), // Unique ID
          type: type,
          detail: detail,
          pitchType: pitchType,
          hitType: hitType,
          velocity: null, // Will be populated if velocity is tracked
          timestamp: new Date().toISOString(),
          count: {
            strikes: gameState.pitching.strikeCounter,
            balls: gameState.pitching.ballCounter,
          },
        };

        gameState.pitching.actions.push(action);

        // Show action history button
        document.getElementById('actionHistoryBtn').classList.remove('hidden');
      }

      function showActionHistoryModal() {
        // Determine which tab is active
        const activeTab = document
          .querySelector('.tab.active')
          .textContent.trim();

        const listContainer = document.getElementById('actionHistoryList');
        const modalTitle = document.querySelector(
          '#actionHistoryModal .modal-title'
        );

        if (activeTab === 'PITCHING') {
          modalTitle.textContent = 'Pitching Actions';
          displayPitchingHistory(listContainer);
        } else if (activeTab === 'BATTING') {
          modalTitle.textContent = 'Batting Actions';
          displayBattingHistory(listContainer);
        } else if (activeTab === 'FIELDING') {
          modalTitle.textContent = 'Fielding Actions';
          displayFieldingHistory(listContainer);
        }

        document.getElementById('actionHistoryModal').classList.add('show');
      }

      function displayPitchingHistory(container) {
        if (gameState.pitching.actions.length === 0) {
          container.innerHTML =
            '<div class="empty-history">No pitching actions yet</div>';
          return;
        }

        let html = '';
        const actions = [...gameState.pitching.actions].reverse();

        actions.forEach((action) => {
          const time = new Date(action.timestamp).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
          });

          let typeText = '';
          let detailText = '';

          if (action.type === 'strike') {
            typeText = 'Strike';
            if (action.detail && action.detail !== 'none') {
              detailText = ` (${action.detail})`;
            }
          } else if (action.type === 'ball') {
            typeText = 'Ball';
          } else if (action.type === 'ballInPlay') {
            typeText = 'Ball in Play';
            detailText = ` - ${action.detail.toUpperCase()}`;
            if (action.hitType) {
              detailText += ` (${action.hitType})`;
            }
          } else if (action.type === 'wildPitch') {
            typeText = 'Wild Pitch + Ball';
          } else if (action.type === 'balks') {
            typeText = 'Balk';
          } else if (action.type === 'pickoffs') {
            typeText = 'Pickoff';
          } else if (action.type === 'runs') {
            typeText = 'Run';
          } else if (action.type === 'earnedRuns') {
            typeText = 'Earned Run';
          }

          let pitchTypeText = '';
          if (action.pitchType) {
            pitchTypeText = ` [${action.pitchType}]`;
          }

          let velocityText = '';
          if (action.velocity) {
            velocityText = ` ${action.velocity} MPH`;
          }

          html += `
            <div class="action-item">
              <div class="action-details">
                <div class="action-type">${typeText}${detailText}${pitchTypeText}${velocityText}</div>
                <div class="action-meta">${time} ‚Ä¢ Count: ${action.count.strikes}-${action.count.balls}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="action-delete" onclick="editAction(${action.id})" style="background: #2196f3;">‚úèÔ∏è</button>
                <button class="action-delete" onclick="deleteAction(${action.id})">√ó</button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function displayBattingHistory(container) {
        if (gameState.batting.actions.length === 0) {
          container.innerHTML =
            '<div class="empty-history">No batting actions yet</div>';
          return;
        }

        let html = '';
        const actions = [...gameState.batting.actions].reverse();

        actions.forEach((action) => {
          const time = new Date(action.timestamp).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
          });

          let typeText = '';
          let detailText = '';

          // Skip baserunning events that aren't plate appearances
          const isBaserunningOnly = ['rbi', 'sb', 'cs', 'pickedOff'].includes(
            action.outcome
          );

          if (isBaserunningOnly) {
            // Format baserunning events
            switch (action.outcome) {
              case 'rbi':
                typeText = 'RBI';
                break;
              case 'sb':
                typeText = 'Stolen Base';
                break;
              case 'cs':
                typeText = 'Caught Stealing';
                break;
              case 'pickedOff':
                typeText = 'Picked Off';
                break;
            }
          } else {
            // Format plate appearance outcomes
            switch (action.outcome) {
              case 'single':
                typeText = 'Single';
                break;
              case 'double':
                typeText = 'Double';
                break;
              case 'triple':
                typeText = 'Triple';
                break;
              case 'hr':
                typeText = 'Home Run';
                break;
              case 'iphr':
                typeText = 'Inside-the-Park HR';
                break;
              case 'out':
                typeText = 'Out';
                break;
              case 'k':
                typeText = 'Strikeout';
                break;
              case 'bb':
                typeText = 'Walk';
                break;
              case 'hbp':
                typeText = 'Hit By Pitch';
                break;
              case 'roe':
                typeText = 'Reached on Error';
                break;
              case 'fc':
                typeText = "Fielder's Choice";
                break;
              case 'sh':
                typeText = 'Sacrifice Bunt';
                break;
              case 'sf':
                typeText = 'Sacrifice Fly';
                break;
              case 'd3k_reached':
                typeText = 'Dropped 3rd K (Reached)';
                break;
              case 'd3k_out':
                typeText = 'Dropped 3rd K (Out)';
                break;
              case 'ci':
                typeText = "Catcher's Interference";
                break;
              case 'strike':
                typeText = 'Strike';
                break;
              case 'foul':
                typeText = 'Foul Ball';
                break;
              default:
                typeText = action.outcome.toUpperCase();
            }

            if (action.hitType) {
              detailText += ` [${action.hitType}]`;
            }

            if (action.hitLocation) {
              detailText += ` to ${action.hitLocation}`;
            }

            if (action.strikeoutType) {
              detailText += ` (${action.strikeoutType})`;
            }

            if (action.risp) {
              detailText += ` ‚Ä¢ RISP`;
            }
          }

          const countText =
            action.strikes > 0 || action.balls > 0
              ? ` ‚Ä¢ Count: ${action.strikes}-${action.balls}`
              : '';

          html += `
            <div class="action-item">
              <div class="action-details">
                <div class="action-type">${typeText}${detailText}</div>
                <div class="action-meta">${time}${countText}</div>
              </div>
              <div style="display: flex; gap: 8px;">
                ${!isBaserunningOnly ? '<button class="action-delete" onclick="editBattingAction(' + action.id + ')" style="background: #2196f3;">‚úèÔ∏è</button>' : ''}
                <button class="action-delete" onclick="deleteBattingAction(${action.id})">√ó</button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function displayFieldingHistory(container) {
        if (gameState.fielding.actions.length === 0) {
          container.innerHTML =
            '<div class="empty-history">No fielding actions yet</div>';
          return;
        }

        let html = '';
        const actions = [...gameState.fielding.actions].reverse();

        actions.forEach((action) => {
          const time = new Date(action.timestamp).toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
          });

          let typeText = '';
          let detailText = '';

          switch (action.type) {
            case 'putout':
              typeText = 'Putout';
              break;
            case 'assist':
              typeText = 'Assist';
              break;
            case 'errors':
              typeText = 'Error';
              break;
            case 'dp':
              typeText = 'Double Play';
              break;
            default:
              typeText = action.type.toUpperCase();
          }

          if (action.playType) {
            detailText = ` (${action.playType})`;
          }

          html += `
          <div class="action-item">
            <div class="action-details">
              <div class="action-type">${action.position} - ${typeText}${detailText}</div>
              <div class="action-meta">${time}</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="action-delete" onclick="editFieldingAction(${action.id})" style="background: #2196f3;">‚úèÔ∏è</button>
              <button class="action-delete" onclick="deleteFieldingAction(${action.id})">√ó</button>
            </div>
          </div>
        `;
        });

        container.innerHTML = html;
      }

      function deleteBattingAction(actionId) {
        if (!confirm('Delete this batting action?')) return;

        const actionIndex = gameState.batting.actions.findIndex(
          (a) => a.id === actionId
        );
        if (actionIndex === -1) return;

        gameState.batting.actions.splice(actionIndex, 1);

        recalculateBattingStats();
        recalculateBattingCount();
        updateBattingDisplay();
        saveGameState();

        if (gameState.batting.actions.length === 0) {
          document.getElementById('actionHistoryBtn').classList.add('hidden');
          closeActionHistoryModal();
        } else {
          showActionHistoryModal();
        }
      }

      function editBattingAction(actionId) {
        const action = gameState.batting.actions.find((a) => a.id === actionId);
        if (!action) return;

        // Skip baserunning-only events
        if (['rbi', 'sb', 'cs', 'pickedOff'].includes(action.outcome)) {
          alert(
            'Baserunning events cannot be edited. Please delete and re-add.'
          );
          return;
        }

        let modalContent = '';

        // Outcome Type
        modalContent += `
          <div style="margin-bottom: 12px;">
            <div class="section-label">Outcome</div>
            <select id="editBattingOutcome" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
              <option value="single" ${action.outcome === 'single' ? 'selected' : ''}>Single</option>
              <option value="double" ${action.outcome === 'double' ? 'selected' : ''}>Double</option>
              <option value="triple" ${action.outcome === 'triple' ? 'selected' : ''}>Triple</option>
              <option value="hr" ${action.outcome === 'hr' ? 'selected' : ''}>Home Run</option>
              <option value="iphr" ${action.outcome === 'iphr' ? 'selected' : ''}>Inside-the-Park HR</option>
              <option value="out" ${action.outcome === 'out' ? 'selected' : ''}>Out</option>
              <option value="k" ${action.outcome === 'k' ? 'selected' : ''}>Strikeout</option>
              <option value="bb" ${action.outcome === 'bb' ? 'selected' : ''}>Walk</option>
              <option value="hbp" ${action.outcome === 'hbp' ? 'selected' : ''}>Hit By Pitch</option>
              <option value="roe" ${action.outcome === 'roe' ? 'selected' : ''}>Reached on Error</option>
              <option value="fc" ${action.outcome === 'fc' ? 'selected' : ''}>Fielder's Choice</option>
              <option value="sh" ${action.outcome === 'sh' ? 'selected' : ''}>Sacrifice Bunt</option>
              <option value="sf" ${action.outcome === 'sf' ? 'selected' : ''}>Sacrifice Fly</option>
              <option value="d3k_reached" ${action.outcome === 'd3k_reached' ? 'selected' : ''}>Dropped 3rd K (Reached)</option>
              <option value="d3k_out" ${action.outcome === 'd3k_out' ? 'selected' : ''}>Dropped 3rd K (Out)</option>
              <option value="ci" ${action.outcome === 'ci' ? 'selected' : ''}>Catcher's Interference</option>
            </select>
          </div>
        `;

        // Hit Type
        modalContent += `
        <div style="margin-bottom: 12px;">
          <div class="section-label">Hit Type</div>
          <select id="editBattingHitType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
            <option value="">None</option>
            <option value="popfly" ${action.hitType === 'popfly' ? 'selected' : ''}>Pop Fly</option>
            <option value="groundball" ${action.hitType === 'groundball' ? 'selected' : ''}>Ground Ball</option>
            <option value="flyball" ${action.hitType === 'flyball' ? 'selected' : ''}>Fly Ball</option>
            <option value="linedrive" ${action.hitType === 'linedrive' ? 'selected' : ''}>Line Drive</option>
            <option value="bunt" ${action.hitType === 'bunt' ? 'selected' : ''}>Bunt</option>
          </select>
        </div>
      `;

        // Hit Location
        modalContent += `
        <div style="margin-bottom: 12px;">
          <div class="section-label">Hit Location</div>
          <select id="editBattingHitLocation" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
            <option value="">None</option>
            <option value="P" ${action.hitLocation === 'P' ? 'selected' : ''}>P</option>
            <option value="C" ${action.hitLocation === 'C' ? 'selected' : ''}>C</option>
            <option value="1B" ${action.hitLocation === '1B' ? 'selected' : ''}>1B</option>
            <option value="2B" ${action.hitLocation === '2B' ? 'selected' : ''}>2B</option>
            <option value="3B" ${action.hitLocation === '3B' ? 'selected' : ''}>3B</option>
            <option value="SS" ${action.hitLocation === 'SS' ? 'selected' : ''}>SS</option>
            <option value="LF" ${action.hitLocation === 'LF' ? 'selected' : ''}>LF</option>
            <option value="CF" ${action.hitLocation === 'CF' ? 'selected' : ''}>CF</option>
            <option value="RF" ${action.hitLocation === 'RF' ? 'selected' : ''}>RF</option>
            <option value="LC" ${action.hitLocation === 'LC' ? 'selected' : ''}>LC GAP</option>
            <option value="RC" ${action.hitLocation === 'RC' ? 'selected' : ''}>RC GAP</option>
          </select>
        </div>
        `;

        // Strikeout Type (for K outcomes)
        if (
          action.outcome === 'k' ||
          action.outcome === 'd3k_reached' ||
          action.outcome === 'd3k_out'
        ) {
          modalContent += `
          <div style="margin-bottom: 12px;">
            <div class="section-label">Strikeout Type</div>
            <select id="editBattingStrikeoutType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
              <option value="">None</option>
              <option value="looking" ${action.strikeoutType === 'looking' ? 'selected' : ''}>Looking</option>
              <option value="swinging" ${action.strikeoutType === 'swinging' ? 'selected' : ''}>Swinging</option>
            </select>
          </div>
        `;
        }

        // RISP
        modalContent += `
        <div style="margin-bottom: 12px;">
          <div class="section-label">Runners in Scoring Position</div>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="editBattingRISP" ${action.risp ? 'checked' : ''} style="width: 18px; height: 18px;">
            <span>RISP</span>
          </label>
        </div>
      `;

        // Count
        modalContent += `
        <div style="margin-bottom: 12px;">
          <div class="section-label">Count (Strikes - Balls)</div>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="editBattingStrikes" value="${action.strikes || 0}" min="0" max="2" style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;" placeholder="Strikes">
            <input type="number" id="editBattingBalls" value="${action.balls || 0}" min="0" max="3" style="flex: 1; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;" placeholder="Balls">
          </div>
        </div>
      `;

        modalContent += `
        <button class="modal-button" onclick="saveEditedBattingAction(${actionId})" style="width: 100%; margin-top: 10px;">SAVE CHANGES</button>
      `;

        document.getElementById('editActionModalBody').innerHTML = modalContent;
        document.getElementById('editActionModal').classList.add('show');
      }

      function saveEditedBattingAction(actionId) {
        const action = gameState.batting.actions.find((a) => a.id === actionId);
        if (!action) return;

        // Update outcome
        const newOutcome = document.getElementById('editBattingOutcome').value;
        action.outcome = newOutcome;

        // Update hit type
        const hitTypeSelect = document.getElementById('editBattingHitType');
        action.hitType = hitTypeSelect.value || null;

        // Update hit location
        const hitLocationSelect = document.getElementById(
          'editBattingHitLocation'
        );
        action.hitLocation = hitLocationSelect.value || null;

        // Update strikeout type (if applicable)
        const strikeoutTypeSelect = document.getElementById(
          'editBattingStrikeoutType'
        );
        if (strikeoutTypeSelect) {
          action.strikeoutType = strikeoutTypeSelect.value || null;
        } else {
          action.strikeoutType = null;
        }

        // Update RISP
        const rispCheckbox = document.getElementById('editBattingRISP');
        action.risp = rispCheckbox.checked;

        // Update count
        const strikesInput = document.getElementById('editBattingStrikes');
        const ballsInput = document.getElementById('editBattingBalls');
        action.strikes = parseInt(strikesInput.value) || 0;
        action.balls = parseInt(ballsInput.value) || 0;

        // Recalculate stats
        recalculateBattingStats();

        closeEditActionModal();
        updateBattingDisplay();
        saveGameState();
        showActionHistoryModal();
      }

      function deleteFieldingAction(actionId) {
        if (!confirm('Delete this fielding action?')) return;

        const actionIndex = gameState.fielding.actions.findIndex(
          (a) => a.id === actionId
        );
        if (actionIndex === -1) return;

        gameState.fielding.actions.splice(actionIndex, 1);

        recalculateFieldingStats();
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();

        if (gameState.fielding.actions.length === 0) {
          document.getElementById('actionHistoryBtn').classList.add('hidden');
          closeActionHistoryModal();
        } else {
          showActionHistoryModal();
        }
      }

      function editFieldingAction(actionId) {
        const action = gameState.fielding.actions.find(
          (a) => a.id === actionId
        );
        if (!action) return;

        let modalContent = '';

        // Position
        modalContent += `
          <div style="margin-bottom: 12px;">
            <div class="section-label">Position</div>
            <select id="editFieldingPosition" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
              <option value="P" ${action.position === 'P' ? 'selected' : ''}>Pitcher (P)</option>
              <option value="C" ${action.position === 'C' ? 'selected' : ''}>Catcher (C)</option>
              <option value="1B" ${action.position === '1B' ? 'selected' : ''}>First Base (1B)</option>
              <option value="2B" ${action.position === '2B' ? 'selected' : ''}>Second Base (2B)</option>
              <option value="3B" ${action.position === '3B' ? 'selected' : ''}>Third Base (3B)</option>
              <option value="SS" ${action.position === 'SS' ? 'selected' : ''}>Shortstop (SS)</option>
              <option value="LF" ${action.position === 'LF' ? 'selected' : ''}>Left Field (LF)</option>
              <option value="CF" ${action.position === 'CF' ? 'selected' : ''}>Center Field (CF)</option>
              <option value="RF" ${action.position === 'RF' ? 'selected' : ''}>Right Field (RF)</option>
              <option value="DH" ${action.position === 'DH' ? 'selected' : ''}>Designated Hitter (DH)</option>
            </select>
          </div>
        `;

        // Type
        modalContent += `
          <div style="margin-bottom: 12px;">
            <div class="section-label">Action Type</div>
            <select id="editFieldingType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
              <option value="putout" ${action.type === 'putout' ? 'selected' : ''}>Putout</option>
              <option value="assist" ${action.type === 'assist' ? 'selected' : ''}>Assist</option>
              <option value="errors" ${action.type === 'errors' ? 'selected' : ''}>Error</option>
              <option value="dp" ${action.type === 'dp' ? 'selected' : ''}>Double Play</option>
            </select>
          </div>
        `;

        // Play Type
        modalContent += `
          <div style="margin-bottom: 12px;">
            <div class="section-label">Play Type</div>
            <select id="editFieldingPlayType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
              <option value="">None</option>
              <option value="flyball" ${action.playType === 'flyball' ? 'selected' : ''}>Fly Ball</option>
              <option value="groundball" ${action.playType === 'groundball' ? 'selected' : ''}>Ground Ball</option>
              <option value="linedrive" ${action.playType === 'linedrive' ? 'selected' : ''}>Line Drive</option>
              <option value="tag" ${action.playType === 'tag' ? 'selected' : ''}>Tag</option>
              <option value="forceout" ${action.playType === 'forceout' ? 'selected' : ''}>Force Out</option>
              <option value="other" ${action.playType === 'other' ? 'selected' : ''}>Other</option>
            </select>
          </div>
        `;

        modalContent += `
          <button class="modal-button" onclick="saveEditedFieldingAction(${actionId})" style="width: 100%; margin-top: 10px;">SAVE CHANGES</button>
        `;

        document.getElementById('editActionModalBody').innerHTML = modalContent;
        document.getElementById('editActionModal').classList.add('show');
      }

      function saveEditedFieldingAction(actionId) {
        const action = gameState.fielding.actions.find(
          (a) => a.id === actionId
        );
        if (!action) return;

        // Get old position before changing
        const oldPosition = action.position;

        // Update position
        const newPosition = document.getElementById(
          'editFieldingPosition'
        ).value;
        action.position = newPosition;

        // Update type
        const newType = document.getElementById('editFieldingType').value;
        action.type = newType;

        // Update play type
        const playTypeSelect = document.getElementById('editFieldingPlayType');
        action.playType = playTypeSelect.value || null;

        // If position changed, make sure the new position exists in gameState
        if (newPosition !== oldPosition) {
          if (!gameState.fielding.positions[newPosition]) {
            gameState.fielding.positions[newPosition] = {
              po: 0,
              assists: 0,
              errors: 0,
              dp: 0,
              innings: 0,
            };
          }
        }

        // Recalculate all fielding stats
        recalculateFieldingStats();

        closeEditActionModal();
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();
        showActionHistoryModal();
      }

      function editAction(actionId) {
        const action = gameState.pitching.actions.find(
          (a) => a.id === actionId
        );
        if (!action) return;

        let modalContent = '';

        // Pitch Type (if applicable)
        if (
          action.type === 'strike' ||
          action.type === 'ball' ||
          action.type === 'ballInPlay' ||
          action.type === 'wildPitch'
        ) {
          modalContent += `
            <div style="margin-bottom: 12px;">
              <div class="section-label">Pitch Type</div>
              <select id="editPitchType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                <option value="">None</option>
                <option value="FB" ${action.pitchType === 'FB' ? 'selected' : ''}>FB</option>
                <option value="CB" ${action.pitchType === 'CB' ? 'selected' : ''}>CB</option>
                <option value="SL" ${action.pitchType === 'SL' ? 'selected' : ''}>SL</option>
                <option value="CU" ${action.pitchType === 'CU' ? 'selected' : ''}>CU</option>
                <option value="OTHER" ${action.pitchType && !['FB', 'CB', 'SL', 'CU'].includes(action.pitchType) ? 'selected' : ''}>OTHER</option>
              </select>
              ${
                action.pitchType &&
                !['FB', 'CB', 'SL', 'CU'].includes(action.pitchType)
                  ? `
                <input type="text" id="editOtherPitchType" value="${action.pitchType}" placeholder="Other pitch type..." style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px; margin-top: 8px;">
              `
                  : ''
              }
            </div>
          `;
        }

        // Batter Action (for strikes)
        if (action.type === 'strike') {
          modalContent += `
            <div style="margin-bottom: 12px;">
              <div class="section-label">Batter Action</div>
              <select id="editBatterAction" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                <option value="">None</option>
                <option value="swinging" ${action.detail === 'swinging' ? 'selected' : ''}>Swinging</option>
                <option value="looking" ${action.detail === 'looking' ? 'selected' : ''}>Looking</option>
                <option value="foul" ${action.detail === 'foul' ? 'selected' : ''}>Foul</option>
              </select>
            </div>
          `;
        }

        // Hit Type (for ball in play)
        if (action.type === 'ballInPlay') {
          modalContent += `
            <div style="margin-bottom: 12px;">
              <div class="section-label">Hit Type</div>
              <select id="editHitType" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                <option value="">None</option>
                <option value="popfly" ${action.hitType === 'popfly' ? 'selected' : ''}>Pop Fly</option>
                <option value="groundball" ${action.hitType === 'groundball' ? 'selected' : ''}>Ground Ball</option>
                <option value="flyball" ${action.hitType === 'flyball' ? 'selected' : ''}>Fly Ball</option>
                <option value="linedrive" ${action.hitType === 'linedrive' ? 'selected' : ''}>Line Drive</option>
                <option value="bunt" ${action.hitType === 'bunt' ? 'selected' : ''}>Bunt</option>
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <div class="section-label">Outcome</div>
              <select id="editOutcome" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
                <option value="out" ${action.detail === 'out' ? 'selected' : ''}>Out</option>
                <option value="single" ${action.detail === 'single' ? 'selected' : ''}>Single</option>
                <option value="double" ${action.detail === 'double' ? 'selected' : ''}>Double</option>
                <option value="triple" ${action.detail === 'triple' ? 'selected' : ''}>Triple</option>
                <option value="hr" ${action.detail === 'hr' ? 'selected' : ''}>Home Run</option>
                <option value="error" ${action.detail === 'error' ? 'selected' : ''}>Error</option>
              </select>
            </div>
          `;
        }

        // Velocity (for all pitch types)
        if (
          action.type === 'strike' ||
          action.type === 'ball' ||
          action.type === 'ballInPlay' ||
          action.type === 'wildPitch'
        ) {
          modalContent += `
            <div style="margin-bottom: 12px;">
              <div class="section-label">Velocity (MPH)</div>
              <input type="number" id="editVelocity" value="${action.velocity || ''}" placeholder="50-110" min="50" max="110" style="width: 100%; padding: 10px; border: 1px solid #d0d0d0; border-radius: 6px;">
            </div>
          `;
        }

        modalContent += `
          <button class="modal-button" onclick="saveEditedAction(${actionId})" style="width: 100%; margin-top: 10px;">SAVE CHANGES</button>
        `;

        document.getElementById('editActionModalBody').innerHTML = modalContent;
        document.getElementById('editActionModal').classList.add('show');
      }

      function closeEditActionModal() {
        document.getElementById('editActionModal').classList.remove('show');
      }

      function saveEditedAction(actionId) {
        const action = gameState.pitching.actions.find(
          (a) => a.id === actionId
        );
        if (!action) return;

        // Get new values from form
        const pitchTypeSelect = document.getElementById('editPitchType');
        if (pitchTypeSelect) {
          let newPitchType = pitchTypeSelect.value || null;
          if (newPitchType === 'OTHER') {
            const otherInput = document.getElementById('editOtherPitchType');
            newPitchType = otherInput ? otherInput.value.trim() : 'OTHER';
          }
          action.pitchType = newPitchType;
        }

        const batterActionSelect = document.getElementById('editBatterAction');
        if (batterActionSelect) {
          action.detail = batterActionSelect.value || 'none';
        }

        const hitTypeSelect = document.getElementById('editHitType');
        if (hitTypeSelect) {
          action.hitType = hitTypeSelect.value || null;
        }

        const outcomeSelect = document.getElementById('editOutcome');
        if (outcomeSelect) {
          action.detail = outcomeSelect.value;
        }

        const velocityInput = document.getElementById('editVelocity');
        if (velocityInput) {
          const velo = parseInt(velocityInput.value);
          if (velo >= 50 && velo <= 110) {
            action.velocity = velo;
            // Update velocities array
            const oldVeloIndex = gameState.pitching.velocities.indexOf(
              action.velocity
            );
            if (oldVeloIndex > -1) {
              gameState.pitching.velocities[oldVeloIndex] = velo;
            } else if (velo) {
              gameState.pitching.velocities.push(velo);
            }
          } else if (velocityInput.value === '') {
            action.velocity = null;
          }
        }

        // Recalculate all stats from actions
        recalculateStatsFromActions();

        closeEditActionModal();
        updatePitchingDisplay();
        updatePitchTypeStats();
        saveGameState();
        showActionHistoryModal();
      }

      function recalculateCurrentCount() {
        // Reset count
        let strikes = 0;
        let balls = 0;

        // Replay all actions to figure out current count
        gameState.pitching.actions.forEach((action) => {
          if (action.type === 'strike') {
            if (action.detail === 'foul' && strikes >= 2) {
              // Foul with 2 strikes doesn't increment
            } else {
              strikes++;
              if (strikes >= 3) {
                // Strikeout - reset count
                strikes = 0;
                balls = 0;
              }
            }
          } else if (action.type === 'ball') {
            balls++;
            if (balls >= 4) {
              // Walk - reset count
              strikes = 0;
              balls = 0;
            }
          } else if (action.type === 'wildPitch') {
            balls++;
            if (balls >= 4) {
              // Walk - reset count
              strikes = 0;
              balls = 0;
            }
          } else if (action.type === 'ballInPlay') {
            // Ball in play - reset count
            strikes = 0;
            balls = 0;
          }
        });

        // Set current counters
        gameState.pitching.strikeCounter = strikes;
        gameState.pitching.ballCounter = balls;
      }

      function recalculateCurrentCount() {
        // Reset count
        let strikes = 0;
        let balls = 0;

        // Replay all actions to figure out current count
        gameState.pitching.actions.forEach((action) => {
          if (action.type === 'strike') {
            if (action.detail === 'foul' && strikes >= 2) {
              // Foul with 2 strikes doesn't increment
            } else {
              strikes++;
              if (strikes >= 3) {
                // Strikeout - reset count
                strikes = 0;
                balls = 0;
              }
            }
          } else if (action.type === 'ball') {
            balls++;
            if (balls >= 4) {
              // Walk - reset count
              strikes = 0;
              balls = 0;
            }
          } else if (action.type === 'wildPitch') {
            balls++;
            if (balls >= 4) {
              // Walk - reset count
              strikes = 0;
              balls = 0;
            }
          } else if (action.type === 'ballInPlay') {
            // Ball in play - reset count
            strikes = 0;
            balls = 0;
          }
        });

        // Set current counters
        gameState.pitching.strikeCounter = strikes;
        gameState.pitching.ballCounter = balls;
      }

      function recalculateStatsFromActions() {
        // Reset stats
        gameState.pitching.stats = {
          ip: 0,
          outs: 0,
          pitchCount: 0,
          strikeouts: 0,
          walks: 0,
          hits: 0,
          runs: 0,
          earnedRuns: 0,
          wildPitches: 0,
          balks: 0,
          pickoffs: 0,
        };
        gameState.pitching.velocities = [];

        // Recalculate from all actions
        gameState.pitching.actions.forEach((action) => {
          if (
            action.type === 'strike' ||
            action.type === 'ball' ||
            action.type === 'ballInPlay' ||
            action.type === 'wildPitch'
          ) {
            gameState.pitching.stats.pitchCount++;
          }

          if (
            action.type === 'strike' &&
            action.count.strikes === 2 &&
            action.detail !== 'foul'
          ) {
            // This was a strikeout
            gameState.pitching.stats.strikeouts++;
            gameState.pitching.stats.outs++;
          }

          if (action.type === 'ball' && action.count.balls === 3) {
            // This was a walk
            gameState.pitching.stats.walks++;
          }

          if (action.type === 'ballInPlay') {
            if (action.detail === 'out') {
              gameState.pitching.stats.outs++;
            } else if (action.detail !== 'error') {
              gameState.pitching.stats.hits++;
              if (action.detail === 'hr') {
                gameState.pitching.stats.runs++;
                gameState.pitching.stats.earnedRuns++;
              }
            }
          }

          if (action.type === 'wildPitch') {
            gameState.pitching.stats.wildPitches++;
            if (action.count.balls === 3) {
              gameState.pitching.stats.walks++;
            }
          }

          if (action.type === 'balks') {
            gameState.pitching.stats.balks++;
          }

          if (action.type === 'pickoffs') {
            gameState.pitching.stats.pickoffs++;
          }

          if (action.type === 'runs') {
            gameState.pitching.stats.runs++;
          }

          if (action.type === 'earnedRuns') {
            gameState.pitching.stats.earnedRuns++;
          }

          if (action.velocity) {
            gameState.pitching.velocities.push(action.velocity);
          }
        });
      }

      function closeActionHistoryModal() {
        document.getElementById('actionHistoryModal').classList.remove('show');
      }

      function deleteAction(actionId) {
        if (!confirm('Delete this action? This will undo its effects.')) return;

        const actionIndex = gameState.pitching.actions.findIndex(
          (a) => a.id === actionId
        );
        if (actionIndex === -1) return;

        // Remove action from history
        gameState.pitching.actions.splice(actionIndex, 1);

        // Recalculate current count from remaining actions
        recalculateCurrentCount();

        // Recalculate ALL stats from remaining actions
        recalculateStatsFromActions();

        // Recalculate ALL stats from remaining actions
        recalculateStatsFromActions();

        // Hide action history button if no actions left
        if (gameState.pitching.actions.length === 0) {
          document.getElementById('actionHistoryBtn').classList.add('hidden');
          closeActionHistoryModal();
        }

        updatePitchingDisplay();
        updatePitchTypeStats();
        saveGameState();

        // Refresh the modal
        if (gameState.pitching.actions.length > 0) {
          showActionHistoryModal();
        }
      }

      // ==========================================
      // HELPER FUNCTIONS
      // ==========================================

      function resetCounters() {
        gameState.pitching.strikeCounter = 0;
        gameState.pitching.ballCounter = 0;
      }

      function updatePitchingDisplay() {
        document.getElementById('strikeCounter').textContent =
          gameState.pitching.strikeCounter;
        document.getElementById('ballCounter').textContent =
          gameState.pitching.ballCounter;
        document.getElementById('wildPitchDisplay').textContent =
          gameState.pitching.stats.wildPitches;
        document.getElementById('balkDisplay').textContent =
          gameState.pitching.stats.balks;
        document.getElementById('pickoffDisplay').textContent =
          gameState.pitching.stats.pickoffs;
        document.getElementById('runsDisplay').textContent =
          gameState.pitching.stats.runs;
        document.getElementById('earnedRunsDisplay').textContent =
          gameState.pitching.stats.earnedRuns;

        const wholeInnings = Math.floor(gameState.pitching.stats.outs / 3);
        const partialOuts = gameState.pitching.stats.outs % 3;
        const ip = wholeInnings + partialOuts / 10;

        document.getElementById('ipStat').textContent = ip.toFixed(1);
        document.getElementById('pitchCountStat').textContent =
          gameState.pitching.stats.pitchCount;
        document.getElementById('kStat').textContent =
          gameState.pitching.stats.strikeouts;
        document.getElementById('bbStat').textContent =
          gameState.pitching.stats.walks;
        document.getElementById('hStat').textContent =
          gameState.pitching.stats.hits;
        document.getElementById('rStat').textContent =
          gameState.pitching.stats.runs;
        document.getElementById('erStat').textContent =
          gameState.pitching.stats.earnedRuns;
        document.getElementById('wpStat').textContent =
          gameState.pitching.stats.wildPitches;
        document.getElementById('balksStat').textContent =
          gameState.pitching.stats.balks;
        document.getElementById('pickoffsStat').textContent =
          gameState.pitching.stats.pickoffs;
      }

      function updatePitchTypeStats() {
        const trackPitchTypes =
          document.getElementById('trackPitchTypes').checked;

        if (!trackPitchTypes) {
          document
            .getElementById('pitchTypeStatsSection')
            .classList.remove('show');
          return;
        }

        // Show the section
        document.getElementById('pitchTypeStatsSection').classList.add('show');

        // Count pitch types from actions AND calculate overall strike %
        const pitchTypes = {};
        let totalPitches = 0;
        let totalStrikes = 0;

        gameState.pitching.actions.forEach((action) => {
          if (
            action.pitchType &&
            (action.type === 'strike' ||
              action.type === 'ball' ||
              action.type === 'ballInPlay' ||
              action.type === 'wildPitch')
          ) {
            if (!pitchTypes[action.pitchType]) {
              pitchTypes[action.pitchType] = { total: 0, strikes: 0, balls: 0 };
            }

            pitchTypes[action.pitchType].total++;
            totalPitches++;

            if (action.type === 'strike' || action.type === 'ballInPlay') {
              pitchTypes[action.pitchType].strikes++;
              totalStrikes++;
            } else if (action.type === 'ball' || action.type === 'wildPitch') {
              pitchTypes[action.pitchType].balls++;
            }
          }
        });

        let html = '';

        // Add overall strike percentage at the top
        if (totalPitches > 0) {
          const overallStrikePct = (
            (totalStrikes / totalPitches) *
            100
          ).toFixed(0);
          html += `<div class="pitch-type-stat" style="background: #e3f2fd; border-left: 3px solid #2196f3; font-weight: 600;">
                    <strong>Overall Strike %:</strong> ${overallStrikePct}% (${totalStrikes} strikes / ${totalPitches} pitches)
                  </div>`;
        }

        if (Object.keys(pitchTypes).length === 0) {
          html += '<div class="pitch-type-stat">No pitch data yet</div>';
        } else {
          for (const [type, stats] of Object.entries(pitchTypes)) {
            const strikePct =
              stats.total > 0
                ? ((stats.strikes / stats.total) * 100).toFixed(0)
                : 0;
            html += `<div class="pitch-type-stat">
                      <strong>${type}:</strong> ${stats.total} (${stats.strikes} strikes, ${stats.balls} balls) - ${strikePct}% strikes
                  </div>`;
          }
        }

        document.getElementById('pitchTypeStatsContent').innerHTML = html;
      }

      // ==========================================
      // RESET FUNCTION
      // ==========================================

      function resetAll() {
        if (
          !confirm(
            'Are you sure you want to reset ALL data? This cannot be undone!'
          )
        ) {
          return;
        }

        // Reset gameState completely
        gameState = {
          gameDate: null,
          opponent: null,
          pitching: {
            strikeCounter: 0,
            ballCounter: 0,
            stats: {
              ip: 0,
              outs: 0,
              pitchCount: 0,
              strikeouts: 0,
              walks: 0,
              hits: 0,
              runs: 0,
              earnedRuns: 0,
              wildPitches: 0,
              balks: 0,
            },
            velocities: [],
            actions: [],
          },
          batting: {
            strikeCounter: 0,
            ballCounter: 0,
            stats: {
              pa: 0,
              ab: 0,
              h: 0,
              singles: 0,
              doubles: 0,
              triples: 0,
              hr: 0,
              iphr: 0,
              rbi: 0,
              bb: 0,
              hbp: 0,
              k: 0,
              kLooking: 0,
              kSwinging: 0,
              sb: 0,
              cs: 0,
              pickedOff: 0,
              sf: 0,
              sh: 0,
              roe: 0,
              fc: 0,
              d3k_reached: 0,
              d3k_out: 0,
              ci: 0,
              ab_risp: 0,
              h_risp: 0,
              rbi_risp: 0,
            },
            actions: [],
          },
          fielding: {
            positions: {},
            actions: [],
          },
        };

        // Reset active position
        activePosition = null;

        // Reset form fields
        document.getElementById('gameDate').valueAsDate = new Date();
        document.getElementById('opponent').value = '';

        // Reset pitching UI
        document.getElementById('pitchingRole').value = 'Starter';
        document.getElementById('reliefInningEntry').classList.remove('show');
        document
          .getElementById('roleContainer')
          .classList.remove('with-relief');
        document.getElementById('reliefInning').value = '';

        // Reset batting UI
        document.getElementById('battingStatus').value = 'Starting';
        document
          .getElementById('substituteInningEntry')
          .classList.remove('show');
        document
          .getElementById('battingStatusContainer')
          .classList.remove('with-substitute');
        document.getElementById('substituteInning').value = '';
        document.getElementById('runnersInScoring').checked = false;

        // Reset all checkboxes
        document.getElementById('trackPitchTypes').checked = false;
        document.getElementById('trackBatterActions').checked = false;
        document.getElementById('trackVelocity').checked = false;
        document.getElementById('trackBattingCount').checked = false;
        document.getElementById('trackHitTypes').checked = false;
        document.getElementById('trackHitLocation').checked = false;
        document.getElementById('trackStrikeoutType').checked = false;
        document.getElementById('trackPlayTypes').checked = false;

        // Hide batting count section
        document.getElementById('battingCountSection').classList.add('hidden');

        // Show manual K and BB buttons
        const manualKBtn = document.getElementById('manualStrikeoutBtn');
        const manualBBBtn = document.getElementById('manualWalkBtn');
        if (manualKBtn) manualKBtn.style.display = 'block';
        if (manualBBBtn) manualBBBtn.style.display = 'block';

        // Hide pitch type stats section
        document
          .getElementById('pitchTypeStatsSection')
          .classList.remove('show');

        // Hide action history button
        document.getElementById('actionHistoryBtn').classList.add('hidden');

        // Update all displays
        updatePitchingDisplay();
        updatePitchTypeStats();
        updateBattingDisplay();
        updateFieldingDisplay();
        updateActivePositionDisplay();
        updatePositionsPlayedList();

        // Clear localStorage
        clearSavedGame();

        alert('‚úÖ All data reset!');
      }

      // ==========================================
      // BATTING FUNCTIONS
      // ==========================================

      let pendingBattingAction = {
        type: null,
        hitType: null,
        hitLocation: null,
        outcome: null,
        strikeoutType: null,
      };

      function handleBattingStatusChange() {
        const status = document.getElementById('battingStatus').value;
        const substituteEntry = document.getElementById(
          'substituteInningEntry'
        );
        const container = document.getElementById('battingStatusContainer');

        if (status === 'Substitute') {
          container.classList.add('with-substitute');
          substituteEntry.classList.add('show');
        } else {
          container.classList.remove('with-substitute');
          substituteEntry.classList.remove('show');
        }
      }

      // Show/hide batting count section based on checkbox
      document
        .getElementById('trackBattingCount')
        ?.addEventListener('change', function () {
          const countSection = document.getElementById('battingCountSection');
          const manualKBtn = document.getElementById('manualStrikeoutBtn');
          const manualBBBtn = document.getElementById('manualWalkBtn');

          if (this.checked) {
            countSection.classList.remove('hidden');
            // Hide manual K and BB buttons
            if (manualKBtn) manualKBtn.style.display = 'none';
            if (manualBBBtn) manualBBBtn.style.display = 'none';
          } else {
            countSection.classList.add('hidden');
            // Show manual K and BB buttons
            if (manualKBtn) manualKBtn.style.display = 'block';
            if (manualBBBtn) manualBBBtn.style.display = 'block';
          }
        });

      // Batting Strike/Ball Counters
      function plusBattingStrike() {
        // Show batter action modal for strike type
        pendingBattingAction = {
          type: 'strike',
          strikeAction: null,
        };
        showBattingStrikeActionModal();
      }

      function showBattingStrikeActionModal() {
        document.getElementById('batterActionsModal').classList.add('show');
      }

      function selectBattingStrikeAction(action) {
        const strikeAction = action === 'SKIP' ? null : action;
        document.getElementById('batterActionsModal').classList.remove('show');

        // Handle foul with 2 strikes (doesn't increment)
        if (strikeAction === 'foul' && gameState.batting.strikeCounter >= 2) {
          // Just record the action, don't increment
          addBattingAction(
            'foul',
            null,
            null,
            null,
            false,
            gameState.batting.strikeCounter,
            gameState.batting.ballCounter
          );
          updateBattingDisplay();
          saveGameState();
        } else {
          // Increment strike counter
          gameState.batting.strikeCounter++;

          // Record action
          addBattingAction(
            'strike',
            null,
            null,
            strikeAction,
            false,
            gameState.batting.strikeCounter,
            gameState.batting.ballCounter
          );

          // Check for strike 3 - show modal
          if (gameState.batting.strikeCounter >= 3) {
            updateBattingDisplay();
            saveGameState();
            showStrike3Modal();
            return; // Don't clear pending action yet
          }

          updateBattingDisplay();
          saveGameState();
        }

        pendingBattingAction = { type: null, strikeAction: null };
      }

      function minusBattingStrike() {
        // Find most recent batting action that involved a strike
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          const action = gameState.batting.actions[i];
          if (action.strikes > 0) {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            recalculateBattingCount();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      function plusBattingBall() {
        gameState.batting.ballCounter++;

        // Auto-walk on ball 4
        if (gameState.batting.ballCounter >= 4) {
          recordBattingOutcome('bb');
        } else {
          updateBattingDisplay();
          saveGameState();
        }
      }

      function minusBattingBall() {
        // Find most recent batting action that involved a ball
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          const action = gameState.batting.actions[i];
          if (action.balls > 0) {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            recalculateBattingCount();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      // Ball in Play Flow
      function startBattingBallInPlay() {
        const trackHitTypes = document.getElementById('trackHitTypes').checked;

        pendingBattingAction = {
          type: 'ballInPlay',
          hitType: null,
          hitLocation: null,
          outcome: null,
        };

        if (trackHitTypes) {
          showBattingHitTypeModal();
        } else {
          const trackHitLocation =
            document.getElementById('trackHitLocation').checked;
          if (trackHitLocation) {
            showBattingHitLocationModal();
          } else {
            showBattingBallInPlayModal();
          }
        }
      }

      function showBattingHitTypeModal() {
        document.getElementById('battingHitTypeModal').classList.add('show');
      }

      function selectBattingHitType(type) {
        pendingBattingAction.hitType = type === 'SKIP' ? null : type;
        document.getElementById('battingHitTypeModal').classList.remove('show');

        const trackHitLocation =
          document.getElementById('trackHitLocation').checked;
        if (trackHitLocation) {
          showBattingHitLocationModal();
        } else {
          showBattingBallInPlayModal();
        }
      }

      function showBattingHitLocationModal() {
        document
          .getElementById('battingHitLocationModal')
          .classList.add('show');
      }

      function selectBattingHitLocation(location) {
        pendingBattingAction.hitLocation =
          location === 'SKIP' ? null : location;
        document
          .getElementById('battingHitLocationModal')
          .classList.remove('show');
        showBattingBallInPlayModal();
      }

      function showBattingBallInPlayModal() {
        document.getElementById('battingBallInPlayModal').classList.add('show');
      }

      function recordBattingBallInPlay(outcome) {
        pendingBattingAction.outcome = outcome;
        document
          .getElementById('battingBallInPlayModal')
          .classList.remove('show');

        const risp = document.getElementById('runnersInScoring').checked;

        // Check if we need to ask about RBIs
        const needsRBIModal = shouldAskForRBI(outcome, risp);

        if (needsRBIModal) {
          showRBIModal(outcome, risp);
        } else {
          // Record without RBI modal
          finalizeBattingAction(outcome, risp, 0);
        }
      }

      // Record Batting Outcome (K, BB, HBP, CI, etc.)
      function recordBattingOutcome(outcome) {
        const risp = document.getElementById('runnersInScoring').checked;
        const trackCount = document.getElementById('trackBattingCount').checked;
        const trackStrikeoutType =
          document.getElementById('trackStrikeoutType').checked;

        // If strikeout and tracking type, show modal
        if (
          (outcome === 'k' ||
            outcome === 'd3k_reached' ||
            outcome === 'd3k_out') &&
          trackStrikeoutType
        ) {
          pendingBattingAction = {
            type: 'outcome',
            outcome: outcome,
            strikeoutType: null,
          };
          showBattingStrikeoutTypeModal();
          return;
        }

        // Otherwise record immediately
        addBattingAction(
          outcome,
          null,
          null,
          null,
          risp,
          trackCount ? gameState.batting.strikeCounter : 0,
          trackCount ? gameState.batting.ballCounter : 0
        );

        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();
      }

      function showBattingStrikeoutTypeModal() {
        document
          .getElementById('battingStrikeoutTypeModal')
          .classList.add('show');
      }

      function selectBattingStrikeoutType(type) {
        const strikeoutType = type === 'SKIP' ? null : type;
        document
          .getElementById('battingStrikeoutTypeModal')
          .classList.remove('show');

        const risp = document.getElementById('runnersInScoring').checked;
        const trackCount = document.getElementById('trackBattingCount').checked;

        addBattingAction(
          pendingBattingAction.outcome,
          null,
          null,
          strikeoutType,
          risp,
          trackCount ? gameState.batting.strikeCounter : 0,
          trackCount ? gameState.batting.ballCounter : 0
        );

        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();

        pendingBattingAction = {
          type: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function shouldAskForRBI(outcome, risp) {
        // Always ask for sac fly and sac bunt
        if (outcome === 'sf' || outcome === 'sh') {
          return true;
        }

        // Ask for HR/IPHR
        if (outcome === 'hr' || outcome === 'iphr') {
          return true;
        }

        // Ask for hits if RISP
        if (risp && ['single', 'double', 'triple'].includes(outcome)) {
          return true;
        }

        return false;
      }

      function showRBIModal(outcome, risp) {
        const modal = document.getElementById('rbiModal');
        const title = document.getElementById('rbiModalTitle');
        const content = document.getElementById('rbiModalContent');

        let html = '';

        if (outcome === 'sf' || outcome === 'sh') {
          // Sac Fly/Bunt - simple yes/no
          title.textContent = 'Did a run score?';
          html = `
            <div class="modal-button-grid">
              <button class="modal-button" onclick="completeRBIEntry(${risp ? 'true' : 'false'}, 1)">YES (1 RBI)</button>
              <button class="modal-button secondary" onclick="completeRBIEntry(${risp ? 'true' : 'false'}, 0)">NO</button>
            </div>
            <button class="modal-button skip" onclick="cancelRBIEntry()">CANCEL</button>
          `;
        } else if (outcome === 'hr' || outcome === 'iphr') {
          // Home Run - ask how many runners on base
          if (risp) {
            title.textContent = 'How many runners were on base?';
            html = `
              <div class="modal-button-grid">
                <button class="modal-button" onclick="completeRBIEntry(true, 1)">0 (Solo)</button>
                <button class="modal-button" onclick="completeRBIEntry(true, 2)">1 (2 RBI)</button>
                <button class="modal-button" onclick="completeRBIEntry(true, 3)">2 (3 RBI)</button>
                <button class="modal-button" onclick="completeRBIEntry(true, 4)">3 (Grand Slam)</button>
              </div>
              <button class="modal-button skip" onclick="cancelRBIEntry()">CANCEL</button>
            `;
          } else {
            // No RISP, but still check if bases loaded somehow
            title.textContent = 'How many runners were on base?';
            html = `
              <div class="modal-button-grid">
                <button class="modal-button" onclick="completeRBIEntry(false, 1)">0 (Solo)</button>
                <button class="modal-button" onclick="completeRBIEntry(false, 2)">1 (2 RBI)</button>
                <button class="modal-button" onclick="completeRBIEntry(false, 3)">2 (3 RBI)</button>
                <button class="modal-button" onclick="completeRBIEntry(false, 4)">3 (Grand Slam)</button>
              </div>
              <button class="modal-button skip" onclick="cancelRBIEntry()">CANCEL</button>
            `;
          }
        } else if (['single', 'double', 'triple'].includes(outcome)) {
          // Regular hit with RISP
          title.textContent = 'How many runs scored?';
          html = `
            <div class="modal-button-grid">
              <button class="modal-button secondary" onclick="completeRBIEntry(true, 0)">0</button>
              <button class="modal-button" onclick="completeRBIEntry(true, 1)">1</button>
              <button class="modal-button" onclick="completeRBIEntry(true, 2)">2</button>
              <button class="modal-button" onclick="completeRBIEntry(true, 3)">3</button>
            </div>
            <button class="modal-button skip" onclick="cancelRBIEntry()">CANCEL</button>
          `;
        }

        content.innerHTML = html;
        modal.classList.add('show');
      }

      function completeRBIEntry(risp, rbiCount) {
        document.getElementById('rbiModal').classList.remove('show');

        // Add the correct number of RBI actions (one per RBI)
        for (let i = 0; i < rbiCount; i++) {
          addBattingAction('rbi', null, null, null, false, 0, 0);
        }

        // Now finalize the batting action
        finalizeBattingAction(pendingBattingAction.outcome, risp, rbiCount);
      }

      function cancelRBIEntry() {
        document.getElementById('rbiModal').classList.remove('show');

        // Reset counters and UI without recording anything
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;

        // Clear pending action
        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
        };

        // No save, no recalculation - just cancel
      }

      function finalizeBattingAction(outcome, risp, rbiCount) {
        const trackCount = document.getElementById('trackBattingCount').checked;

        addBattingAction(
          outcome,
          pendingBattingAction.hitType,
          pendingBattingAction.hitLocation,
          null,
          risp,
          trackCount ? gameState.batting.strikeCounter : 0,
          trackCount ? gameState.batting.ballCounter : 0
        );

        // Reset counters and UI
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();

        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
        };
      }

      // ==========================================
      // MODAL CANCEL FUNCTIONS
      // ==========================================

      function cancelPitchTypeModal() {
        document.getElementById('pitchTypeModal').classList.remove('show');
        document.getElementById('otherPitchTypeInput').value = '';
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
      }

      function cancelBatterActionsModal() {
        document.getElementById('batterActionsModal').classList.remove('show');
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function cancelHitTypeModal() {
        document.getElementById('hitTypeModal').classList.remove('show');
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
      }

      function cancelBallInPlayModal() {
        document.getElementById('ballInPlayModal').classList.remove('show');
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
      }

      function cancelVelocityModal() {
        document.getElementById('velocityModal').classList.remove('show');
        document.getElementById('velocityModalInput').value = '';
        pendingAction = {
          type: null,
          pitchType: null,
          batterAction: null,
          hitType: null,
          outcome: null,
        };
        saveGameState();
      }

      function cancelBattingHitTypeModal() {
        document.getElementById('battingHitTypeModal').classList.remove('show');
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;
        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function cancelBattingHitLocationModal() {
        document
          .getElementById('battingHitLocationModal')
          .classList.remove('show');
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;
        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function cancelBattingBallInPlayModal() {
        document
          .getElementById('battingBallInPlayModal')
          .classList.remove('show');
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;
        pendingBattingAction = {
          type: null,
          hitType: null,
          hitLocation: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function cancelBattingStrikeoutTypeModal() {
        document
          .getElementById('battingStrikeoutTypeModal')
          .classList.remove('show');
        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;
        pendingBattingAction = {
          type: null,
          outcome: null,
          strikeoutType: null,
        };
      }

      function cancelStrike3Modal() {
        document.getElementById('strike3Modal').classList.remove('show');

        // Decrement strike counter back to 2
        gameState.batting.strikeCounter = 2;

        // Remove the last strike action
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (
            gameState.batting.actions[i].outcome === 'strike' ||
            gameState.batting.actions[i].outcome === 'foul'
          ) {
            gameState.batting.actions.splice(i, 1);
            break;
          }
        }

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();

        pendingBattingAction = { type: null, strikeAction: null };
      }

      function showStrike3Modal() {
        document.getElementById('strike3Modal').classList.add('show');
      }

      function recordStrike3Outcome(outcome) {
        document.getElementById('strike3Modal').classList.remove('show');

        const risp = document.getElementById('runnersInScoring').checked;
        const trackStrikeoutType =
          document.getElementById('trackStrikeoutType').checked;

        // If tracking strikeout type, show that modal next
        if (trackStrikeoutType && outcome === 'k') {
          pendingBattingAction = {
            type: 'outcome',
            outcome: outcome,
            strikeoutType: null,
          };
          showBattingStrikeoutTypeModal();
          return;
        }

        // Otherwise record immediately
        const trackCount = document.getElementById('trackBattingCount').checked;
        addBattingAction(
          outcome,
          null,
          null,
          null,
          risp,
          trackCount ? gameState.batting.strikeCounter : 0,
          trackCount ? gameState.batting.ballCounter : 0
        );

        resetBattingCounters();
        document.getElementById('runnersInScoring').checked = false;

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();

        pendingBattingAction = { type: null, strikeAction: null };
      }

      function cancelStrike3Modal() {
        document.getElementById('strike3Modal').classList.remove('show');

        // Decrement strike counter back to 2
        gameState.batting.strikeCounter = 2;

        // Remove the last strike action
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (
            gameState.batting.actions[i].outcome === 'strike' ||
            gameState.batting.actions[i].outcome === 'foul'
          ) {
            gameState.batting.actions.splice(i, 1);
            break;
          }
        }

        recalculateBattingStats();
        updateBattingDisplay();
        saveGameState();

        pendingBattingAction = { type: null, strikeAction: null };
      }

      function cancelPlayTypeModal() {
        document.getElementById('playTypeModal').classList.remove('show');
        pendingFieldingAction = { type: null, playType: null };
      }

      // Add batting action to history
      function addBattingAction(
        outcome,
        hitType,
        hitLocation,
        strikeoutType,
        risp,
        strikes,
        balls
      ) {
        const action = {
          id: Date.now() + Math.random(),
          outcome: outcome,
          hitType: hitType,
          hitLocation: hitLocation,
          strikeoutType: strikeoutType,
          risp: risp,
          strikes: strikes,
          balls: balls,
          timestamp: new Date().toISOString(),
        };

        gameState.batting.actions.push(action);

        // Show action history button
        document.getElementById('actionHistoryBtn').classList.remove('hidden');
      }

      // Baserunning event adjustments
      function adjustBattingEvent(stat, delta) {
        gameState.batting.stats[stat] = Math.max(
          0,
          gameState.batting.stats[stat] + delta
        );

        if (delta > 0) {
          addBattingAction(stat, null, null, null, false, 0, 0);
        }

        updateBattingDisplay();
        saveGameState();
      }

      function minusRBI() {
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (gameState.batting.actions[i].outcome === 'rbi') {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      function minusSB() {
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (gameState.batting.actions[i].outcome === 'sb') {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      function minusCS() {
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (gameState.batting.actions[i].outcome === 'cs') {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      function minusPickedOff() {
        for (let i = gameState.batting.actions.length - 1; i >= 0; i--) {
          if (gameState.batting.actions[i].outcome === 'pickedOff') {
            gameState.batting.actions.splice(i, 1);
            recalculateBattingStats();
            updateBattingDisplay();
            saveGameState();
            return;
          }
        }
      }

      function resetBattingCounters() {
        gameState.batting.strikeCounter = 0;
        gameState.batting.ballCounter = 0;
      }

      function recalculateBattingCount() {
        let strikes = 0;
        let balls = 0;

        gameState.batting.actions.forEach((action) => {
          // Skip baserunning events
          if (['rbi', 'sb', 'cs', 'pickedOff'].includes(action.outcome)) {
            return;
          }

          // If action completes a PA, reset count
          if (
            [
              'k',
              'bb',
              'hbp',
              'ci',
              'd3k_reached',
              'd3k_out',
              'single',
              'double',
              'triple',
              'hr',
              'iphr',
              'out',
              'roe',
              'fc',
              'sh',
              'sf',
            ].includes(action.outcome)
          ) {
            strikes = 0;
            balls = 0;
          }
        });

        gameState.batting.strikeCounter = strikes;
        gameState.batting.ballCounter = balls;
      }

      function recalculateBattingStats() {
        // Reset stats
        gameState.batting.stats = {
          pa: 0,
          ab: 0,
          h: 0,
          singles: 0,
          doubles: 0,
          triples: 0,
          hr: 0,
          iphr: 0,
          rbi: 0,
          bb: 0,
          hbp: 0,
          k: 0,
          kLooking: 0,
          kSwinging: 0,
          sb: 0,
          cs: 0,
          pickedOff: 0,
          sf: 0,
          sh: 0,
          roe: 0,
          fc: 0,
          d3k_reached: 0,
          d3k_out: 0,
          ci: 0,
          ab_risp: 0,
          h_risp: 0,
          rbi_risp: 0,
        };

        // Recalculate from actions
        gameState.batting.actions.forEach((action) => {
          const outcome = action.outcome;
          const risp = action.risp;

          // Skip baserunning-only events
          if (outcome === 'rbi') {
            gameState.batting.stats.rbi++;
            return;
          }
          if (outcome === 'sb') {
            gameState.batting.stats.sb++;
            return;
          }
          if (outcome === 'cs') {
            gameState.batting.stats.cs++;
            return;
          }
          if (outcome === 'pickedOff') {
            gameState.batting.stats.pickedOff++;
            return;
          }

          // Skip mid-at-bat actions (strikes, fouls)
          if (outcome === 'strike' || outcome === 'foul') {
            return;
          }

          // Plate appearances (everything else counts as a PA)
          gameState.batting.stats.pa++;

          let countsAsAB = true;
          let isHit = false;

          switch (outcome) {
            case 'single':
              gameState.batting.stats.singles++;
              gameState.batting.stats.h++;
              isHit = true;
              if (risp) gameState.batting.stats.h_risp++;
              break;
            case 'double':
              gameState.batting.stats.doubles++;
              gameState.batting.stats.h++;
              isHit = true;
              if (risp) gameState.batting.stats.h_risp++;
              break;
            case 'triple':
              gameState.batting.stats.triples++;
              gameState.batting.stats.h++;
              isHit = true;
              if (risp) gameState.batting.stats.h_risp++;
              break;
            case 'hr':
              gameState.batting.stats.hr++;
              gameState.batting.stats.h++;
              isHit = true;
              if (risp) gameState.batting.stats.h_risp++;
              break;
            case 'iphr':
              gameState.batting.stats.iphr++;
              gameState.batting.stats.hr++;
              gameState.batting.stats.h++;
              isHit = true;
              if (risp) gameState.batting.stats.h_risp++;
              break;
            case 'out':
              break;
            case 'k':
              gameState.batting.stats.k++;
              if (action.strikeoutType === 'looking') {
                gameState.batting.stats.kLooking++;
              } else if (action.strikeoutType === 'swinging') {
                gameState.batting.stats.kSwinging++;
              }
              break;
            case 'bb':
              gameState.batting.stats.bb++;
              countsAsAB = false;
              break;
            case 'hbp':
              gameState.batting.stats.hbp++;
              countsAsAB = false;
              break;
            case 'roe':
              gameState.batting.stats.roe++;
              break;
            case 'd3k_reached':
              gameState.batting.stats.d3k_reached++;
              gameState.batting.stats.k++;
              if (action.strikeoutType === 'looking') {
                gameState.batting.stats.kLooking++;
              } else if (action.strikeoutType === 'swinging') {
                gameState.batting.stats.kSwinging++;
              }
              break;
            case 'd3k_out':
              gameState.batting.stats.d3k_out++;
              gameState.batting.stats.k++;
              if (action.strikeoutType === 'looking') {
                gameState.batting.stats.kLooking++;
              } else if (action.strikeoutType === 'swinging') {
                gameState.batting.stats.kSwinging++;
              }
              break;
            case 'fc':
              gameState.batting.stats.fc++;
              break;
            case 'sh':
              gameState.batting.stats.sh++;
              countsAsAB = false;
              break;
            case 'sf':
              gameState.batting.stats.sf++;
              countsAsAB = false;
              break;
            case 'ci':
              gameState.batting.stats.ci++;
              countsAsAB = false;
              break;
          }

          if (countsAsAB) {
            gameState.batting.stats.ab++;
            if (risp) {
              gameState.batting.stats.ab_risp++;
            }
          }
        });
      }

      function updateBattingDisplay() {
        document.getElementById('battingStrikeCounter').textContent =
          gameState.batting.strikeCounter;
        document.getElementById('battingBallCounter').textContent =
          gameState.batting.ballCounter;
        document.getElementById('rbiDisplay').textContent =
          gameState.batting.stats.rbi;
        document.getElementById('sbDisplay').textContent =
          gameState.batting.stats.sb;
        document.getElementById('csDisplay').textContent =
          gameState.batting.stats.cs;
        document.getElementById('pickedOffDisplay').textContent =
          gameState.batting.stats.pickedOff;

        // Update stats section
        const stats = gameState.batting.stats;

        document.getElementById('battingPAStat').textContent = stats.pa;
        document.getElementById('battingABStat').textContent = stats.ab;
        document.getElementById('battingHStat').textContent = stats.h;
        document.getElementById('batting2BStat').textContent = stats.doubles;
        document.getElementById('batting3BStat').textContent = stats.triples;
        document.getElementById('battingHRStat').textContent = stats.hr;
        document.getElementById('battingRBIStat').textContent = stats.rbi;
        document.getElementById('battingBBStat').textContent = stats.bb;
        document.getElementById('battingKStat').textContent = stats.k;

        // Advanced stats
        const avg = stats.ab > 0 ? stats.h / stats.ab : 0;
        const obp =
          stats.ab + stats.bb + stats.hbp > 0
            ? (stats.h + stats.bb + stats.hbp) /
              (stats.ab + stats.bb + stats.hbp + stats.sf)
            : 0;
        const tb =
          stats.singles + 2 * stats.doubles + 3 * stats.triples + 4 * stats.hr;
        const slg = stats.ab > 0 ? tb / stats.ab : 0;
        const ops = obp + slg;
        const babip =
          stats.ab - stats.k - stats.hr + stats.sf > 0
            ? (stats.h - stats.hr) / (stats.ab - stats.k - stats.hr + stats.sf)
            : 0;

        document.getElementById('battingAVGStat').textContent = avg.toFixed(3);
        document.getElementById('battingOBPStat').textContent = obp.toFixed(3);
        document.getElementById('battingSLGStat').textContent = slg.toFixed(3);
        document.getElementById('battingOPSStat').textContent = ops.toFixed(3);
        document.getElementById('battingBABIPStat').textContent =
          babip.toFixed(3);
        document.getElementById('battingTBStat').textContent = tb;
      }

      // ==========================================
      // FIELDING FUNCTIONS
      // ==========================================

      let activePosition = null;
      let pendingFieldingAction = {
        type: null,
        playType: null,
      };

      // Position Management
      function showSelectPositionModal() {
        document.getElementById('selectPositionModal').classList.add('show');
      }

      function closeSelectPositionModal() {
        document.getElementById('selectPositionModal').classList.remove('show');
      }

      function setActivePosition() {
        const position = document.getElementById('positionSelect').value;
        activePosition = position;

        // Initialize position in gameState if not exists
        if (!gameState.fielding.positions[position]) {
          gameState.fielding.positions[position] = {
            po: 0,
            assists: 0,
            errors: 0,
            dp: 0,
            innings: 0,
          };
        }

        closeSelectPositionModal();
        updateActivePositionDisplay();
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();
      }

      function updateActivePositionDisplay() {
        const display = document.getElementById('activePositionDisplay');
        if (activePosition) {
          display.textContent = `Active: ${activePosition}`;
          display.style.background = '#e3f2fd';
          display.style.color = '#1976d2';
        } else {
          display.textContent = 'No position selected';
          display.style.background = '#ffebee';
          display.style.color = '#c62828';
        }
      }

      function updatePositionsPlayedList() {
        const container = document.getElementById('positionsPlayedList');

        // Check if fielding structure exists
        if (!gameState.fielding || !gameState.fielding.positions) {
          gameState.fielding = {
            positions: {},
            actions: [],
          };
        }

        if (Object.keys(gameState.fielding.positions).length === 0) {
          container.innerHTML =
            '<div style="padding: 8px; text-align: center; color: #999; font-size: 12px; font-style: italic;">No positions recorded yet</div>';
        } else {
          let html = '';
          for (const [pos, stats] of Object.entries(
            gameState.fielding.positions
          )) {
            const tc = stats.po + stats.assists + stats.errors;
            const fpct =
              tc > 0 ? ((stats.po + stats.assists) / tc).toFixed(3) : '.000';

            html += `
              <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; margin-bottom: 6px; ${pos === activePosition ? 'border: 2px solid #2196f3;' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                  <span style="font-weight: 700; font-size: 14px;">${pos}</span>
                  <div style="display: flex; gap: 6px; align-items: center;">
                    ${
                      pos === activePosition
                        ? '<span style="color: #2196f3; font-size: 11px; font-weight: 600;">‚óè ACTIVE</span>'
                        : '<button onclick="setActiveFieldingPosition(\'' +
                          pos +
                          '\')" style="padding: 4px 8px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer;">SET ACTIVE</button>'
                    }
                    <button onclick="editFieldingPosition('${pos}')" style="width: 28px; height: 28px; background: #2196f3; color: white; border: none; border-radius: 50%; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è</button>
                    <button onclick="deleteFieldingPosition('${pos}')" style="width: 28px; height: 28px; background: #f44336; color: white; border: none; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;">√ó</button>
                  </div>
                </div>
                <div style="font-size: 11px; color: #666;">
                  PO: ${stats.po} | A: ${stats.assists} | E: ${stats.errors} | DP: ${stats.dp}
                </div>
                <div style="font-size: 11px; color: #666; margin-top: 2px;">
                  TC: ${tc} | FLD%: ${fpct}
                </div>
                <div style="margin-top: 6px; display: flex; gap: 6px; align-items: center;">
                  <input
                    type="number"
                    value="${stats.innings}"
                    oninput="handleBaseballInningsInput(this, '${pos}')"
                    onchange="updatePositionInnings('${pos}', this.value)"
                    placeholder="0.0"
                    step="0.1"
                    min="0"
                    style="flex: 1; padding: 4px; border: 1px solid #d0d0d0; border-radius: 4px; font-size: 11px;"
                    title="Baseball innings: Use .0, .1, or .2 only (e.g., 3.2 = 3 innings + 2 outs)"
                  />
                  <span style="font-size: 11px; color: #666;">IP</span>
                </div>
              </div>
            `;
          }
          container.innerHTML = html;
        }
      }

      function deleteFieldingPosition(position) {
        if (
          !confirm(
            `Delete position ${position}? This will remove all stats and actions for this position.`
          )
        ) {
          return;
        }

        // Remove position from gameState
        delete gameState.fielding.positions[position];

        // Remove all actions for this position
        gameState.fielding.actions = gameState.fielding.actions.filter(
          (action) => action.position !== position
        );

        // Clear active position if it was deleted
        if (activePosition === position) {
          activePosition = null;
          updateActivePositionDisplay();
        }

        // Update displays
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();

        // Hide action history button if no actions left
        if (gameState.fielding.actions.length === 0) {
          document.getElementById('actionHistoryBtn').classList.add('hidden');
        }
      }

      function editFieldingPosition(oldPosition) {
        const newPosition = prompt(
          `Change position from ${oldPosition} to:`,
          oldPosition
        );

        if (!newPosition || newPosition === oldPosition) {
          return;
        }

        // Validate position
        const validPositions = [
          'P',
          'C',
          '1B',
          '2B',
          '3B',
          'SS',
          'LF',
          'CF',
          'RF',
          'DH',
        ];
        if (!validPositions.includes(newPosition)) {
          alert(
            'Invalid position! Must be one of: P, C, 1B, 2B, 3B, SS, LF, CF, RF, DH'
          );
          return;
        }

        // Check if new position already exists
        if (gameState.fielding.positions[newPosition]) {
          if (
            !confirm(
              `Position ${newPosition} already exists. Merge stats with existing position?`
            )
          ) {
            return;
          }
          // Merge stats
          gameState.fielding.positions[newPosition].po +=
            gameState.fielding.positions[oldPosition].po;
          gameState.fielding.positions[newPosition].assists +=
            gameState.fielding.positions[oldPosition].assists;
          gameState.fielding.positions[newPosition].errors +=
            gameState.fielding.positions[oldPosition].errors;
          gameState.fielding.positions[newPosition].dp +=
            gameState.fielding.positions[oldPosition].dp;
          gameState.fielding.positions[newPosition].innings +=
            gameState.fielding.positions[oldPosition].innings;

          // Delete old position
          delete gameState.fielding.positions[oldPosition];
        } else {
          // Just rename
          gameState.fielding.positions[newPosition] =
            gameState.fielding.positions[oldPosition];
          delete gameState.fielding.positions[oldPosition];
        }

        // Update all actions with new position
        gameState.fielding.actions.forEach((action) => {
          if (action.position === oldPosition) {
            action.position = newPosition;
          }
        });

        // Update active position if it was changed
        if (activePosition === oldPosition) {
          activePosition = newPosition;
          updateActivePositionDisplay();
        }

        // Update displays
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();
      }

      function setActiveFieldingPosition(position) {
        activePosition = position;
        updateActivePositionDisplay();
        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();
      }

      function updatePositionInnings(position, value) {
        const innings = parseFloat(value) || 0;
        gameState.fielding.positions[position].innings = innings;
        saveGameState();
      }

      function handleBaseballInningsInput(input, position) {
        let value = parseFloat(input.value) || 0;

        // Extract whole innings and decimal part
        const wholeInnings = Math.floor(value);
        const decimal = Math.round((value - wholeInnings) * 10);

        let correctedValue = value;

        // Handle invalid decimals
        if (decimal >= 3) {
          // Roll over to next inning
          // 1.3 becomes 2.0, 1.4 becomes 2.1, etc.
          const extraOuts = decimal - 3;
          const nextInning = wholeInnings + 1;

          if (extraOuts >= 3) {
            // Multiple rollovers needed
            const additionalInnings = Math.floor(extraOuts / 3);
            const remainingOuts = extraOuts % 3;
            correctedValue =
              nextInning + additionalInnings + remainingOuts / 10;
          } else {
            correctedValue = nextInning + extraOuts / 10;
          }

          input.value = correctedValue.toFixed(1);
          gameState.fielding.positions[position].innings = correctedValue;
          saveGameState();
        } else if (decimal > 2) {
          // .3 - .9 rounds to next valid value
          // This catches edge cases
          correctedValue = wholeInnings + 1.0;
          input.value = correctedValue.toFixed(1);
          gameState.fielding.positions[position].innings = correctedValue;
          saveGameState();
        } else {
          // Valid: .0, .1, .2
          gameState.fielding.positions[position].innings = value;
        }
      }

      // Putout with optional play type
      function addPutout() {
        if (!activePosition) {
          alert('Please select an active position first!');
          showSelectPositionModal();
          return;
        }

        const trackPlayTypes =
          document.getElementById('trackPlayTypes').checked;

        if (trackPlayTypes) {
          pendingFieldingAction = {
            type: 'putout',
            playType: null,
          };
          showPlayTypeModal();
        } else {
          // Record immediately without play type
          addFieldingAction(activePosition, 'putout', null);
          gameState.fielding.positions[activePosition].po++;
          updateFieldingDisplay();
          updatePositionsPlayedList();
          saveGameState();
        }
      }

      function minusPutout() {
        if (!activePosition) return;

        for (let i = gameState.fielding.actions.length - 1; i >= 0; i--) {
          if (
            gameState.fielding.actions[i].type === 'putout' &&
            gameState.fielding.actions[i].position === activePosition
          ) {
            gameState.fielding.actions.splice(i, 1);
            recalculateFieldingStats();
            updateFieldingDisplay();
            updatePositionsPlayedList();
            saveGameState();
            return;
          }
        }
      }

      // Assist with optional play type
      function addAssist() {
        if (!activePosition) {
          alert('Please select an active position first!');
          showSelectPositionModal();
          return;
        }

        const trackPlayTypes =
          document.getElementById('trackPlayTypes').checked;

        if (trackPlayTypes) {
          pendingFieldingAction = {
            type: 'assist',
            playType: null,
          };
          showPlayTypeModal();
        } else {
          // Record immediately without play type
          addFieldingAction(activePosition, 'assist', null);
          gameState.fielding.positions[activePosition].assists++;
          updateFieldingDisplay();
          updatePositionsPlayedList();
          saveGameState();
        }
      }

      function minusAssist() {
        if (!activePosition) return;

        for (let i = gameState.fielding.actions.length - 1; i >= 0; i--) {
          if (
            gameState.fielding.actions[i].type === 'assist' &&
            gameState.fielding.actions[i].position === activePosition
          ) {
            gameState.fielding.actions.splice(i, 1);
            recalculateFieldingStats();
            updateFieldingDisplay();
            updatePositionsPlayedList();
            saveGameState();
            return;
          }
        }
      }

      // Play Type Modal
      function showPlayTypeModal() {
        document.getElementById('playTypeModal').classList.add('show');
      }

      function selectPlayType(type) {
        const playType = type === 'SKIP' ? null : type;
        document.getElementById('playTypeModal').classList.remove('show');

        // Record the action
        if (pendingFieldingAction.type === 'putout') {
          addFieldingAction(activePosition, 'putout', playType);
          gameState.fielding.positions[activePosition].po++;
        } else if (pendingFieldingAction.type === 'assist') {
          addFieldingAction(activePosition, 'assist', playType);
          gameState.fielding.positions[activePosition].assists++;
        }

        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();

        pendingFieldingAction = { type: null, playType: null };
      }

      // Simple event adjustments (errors, DP)
      function adjustFieldingEvent(stat, delta) {
        if (!activePosition) {
          alert('Please select an active position first!');
          showSelectPositionModal();
          return;
        }

        // Ensure position exists in gameState
        if (!gameState.fielding.positions[activePosition]) {
          gameState.fielding.positions[activePosition] = {
            po: 0,
            assists: 0,
            errors: 0,
            dp: 0,
            innings: 0,
          };
        }

        gameState.fielding.positions[activePosition][stat] = Math.max(
          0,
          gameState.fielding.positions[activePosition][stat] + delta
        );

        if (delta > 0) {
          addFieldingAction(activePosition, stat, null);
        }

        updateFieldingDisplay();
        updatePositionsPlayedList();
        saveGameState();
      }

      function minusError() {
        if (!activePosition) return;

        for (let i = gameState.fielding.actions.length - 1; i >= 0; i--) {
          if (
            gameState.fielding.actions[i].type === 'errors' &&
            gameState.fielding.actions[i].position === activePosition
          ) {
            gameState.fielding.actions.splice(i, 1);
            recalculateFieldingStats();
            updateFieldingDisplay();
            updatePositionsPlayedList();
            saveGameState();
            return;
          }
        }
      }

      function minusDP() {
        if (!activePosition) return;

        for (let i = gameState.fielding.actions.length - 1; i >= 0; i--) {
          if (
            gameState.fielding.actions[i].type === 'dp' &&
            gameState.fielding.actions[i].position === activePosition
          ) {
            gameState.fielding.actions.splice(i, 1);
            recalculateFieldingStats();
            updateFieldingDisplay();
            updatePositionsPlayedList();
            saveGameState();
            return;
          }
        }
      }

      // Add fielding action to history
      function addFieldingAction(position, type, playType) {
        const action = {
          id: Date.now() + Math.random(),
          position: position,
          type: type,
          playType: playType,
          timestamp: new Date().toISOString(),
        };

        gameState.fielding.actions.push(action);

        // Show action history button
        document.getElementById('actionHistoryBtn').classList.remove('hidden');
      }

      function recalculateFieldingStats() {
        // Reset all position stats
        for (const pos of Object.keys(gameState.fielding.positions)) {
          gameState.fielding.positions[pos].po = 0;
          gameState.fielding.positions[pos].assists = 0;
          gameState.fielding.positions[pos].errors = 0;
          gameState.fielding.positions[pos].dp = 0;
        }

        // Recalculate from actions
        gameState.fielding.actions.forEach((action) => {
          const pos = action.position;

          if (!gameState.fielding.positions[pos]) {
            gameState.fielding.positions[pos] = {
              po: 0,
              assists: 0,
              errors: 0,
              dp: 0,
              innings: 0,
            };
          }

          if (action.type === 'putout') {
            gameState.fielding.positions[pos].po++;
          } else if (action.type === 'assist') {
            gameState.fielding.positions[pos].assists++;
          } else if (action.type === 'errors') {
            gameState.fielding.positions[pos].errors++;
          } else if (action.type === 'dp') {
            gameState.fielding.positions[pos].dp++;
          }
        });
      }

      function updateFieldingDisplay() {
        // STEP 1: Ensure fielding structure exists
        if (!gameState.fielding) {
          gameState.fielding = { positions: {}, actions: [] };
        }
        if (!gameState.fielding.positions) {
          gameState.fielding.positions = {};
        }
        if (!gameState.fielding.actions) {
          gameState.fielding.actions = [];
        }

        // STEP 2: Try to get active position stats (with super defensive checks)
        let stats = null;
        if (
          activePosition &&
          gameState.fielding.positions &&
          gameState.fielding.positions[activePosition] &&
          typeof gameState.fielding.positions[activePosition] === 'object'
        ) {
          stats = gameState.fielding.positions[activePosition];
        }

        // STEP 3: Update current position display
        if (stats) {
          document.getElementById('putoutsDisplay').textContent = stats.po || 0;
          document.getElementById('assistsDisplay').textContent =
            stats.assists || 0;
          document.getElementById('errorsDisplay').textContent =
            stats.errors || 0;
          document.getElementById('dpDisplay').textContent = stats.dp || 0;
        } else {
          document.getElementById('putoutsDisplay').textContent = '0';
          document.getElementById('assistsDisplay').textContent = '0';
          document.getElementById('errorsDisplay').textContent = '0';
          document.getElementById('dpDisplay').textContent = '0';
        }

        // STEP 4: Calculate totals across ALL positions (always do this)
        let totalPO = 0,
          totalA = 0,
          totalE = 0,
          totalDP = 0;

        if (
          gameState.fielding.positions &&
          typeof gameState.fielding.positions === 'object'
        ) {
          for (const position in gameState.fielding.positions) {
            const posStats = gameState.fielding.positions[position];
            if (posStats && typeof posStats === 'object') {
              totalPO += posStats.po || 0;
              totalA += posStats.assists || 0;
              totalE += posStats.errors || 0;
              totalDP += posStats.dp || 0;
            }
          }
        }

        const tc = totalPO + totalA + totalE;
        const fieldingPct = tc > 0 ? (totalPO + totalA) / tc : 0;

        document.getElementById('fieldingPOStat').textContent = totalPO;
        document.getElementById('fieldingAStat').textContent = totalA;
        document.getElementById('fieldingEStat').textContent = totalE;
        document.getElementById('fieldingDPStat').textContent = totalDP;
        document.getElementById('fieldingTCStat').textContent = tc;
        document.getElementById('fieldingPctStat').textContent =
          fieldingPct.toFixed(3);
      }

      // ==========================================
      // EXPORT FUNCTION
      // ==========================================

      function exportGameData() {
        // Validate required fields
        const gameDate = document.getElementById('gameDate').value;
        const opponent = document.getElementById('opponent').value;

        if (!gameDate || !opponent) {
          alert('Please enter Game Date and Opponent before exporting!');
          return;
        }

        // Build export object
        const exportData = {
          date: gameDate,
          opponent: opponent,
        };

        // Add pitching data if exists
        if (gameState.pitching.actions.length > 0) {
          exportData.pitching = buildPitchingExport();
        }

        // Add batting data if exists
        if (gameState.batting.actions.length > 0) {
          exportData.batting = buildBattingExport();
        }

        // Add fielding data if exists
        if (Object.keys(gameState.fielding.positions).length > 0) {
          exportData.fielding = buildFieldingExport();
        }

        // Check if any data exists
        if (
          !exportData.pitching &&
          !exportData.batting &&
          !exportData.fielding
        ) {
          alert('No game data to export! Track some stats first.');
          return;
        }

        // Generate filename
        const filename = `game_${gameDate}_${opponent.replace(/\s+/g, '_')}.json`;

        // Download JSON file
        downloadJSON(exportData, filename);

        alert(
          `‚úÖ Game data exported!\n\nFile: ${filename}\n\nYou can now import this into the Python analytics system.`
        );
      }

      function buildPitchingExport() {
        const role = document.getElementById('pitchingRole').value;
        const reliefInning = document.getElementById('reliefInning').value;

        // Calculate IP in baseball notation
        const wholeInnings = Math.floor(gameState.pitching.stats.outs / 3);
        const partialOuts = gameState.pitching.stats.outs % 3;
        const ip = parseFloat(`${wholeInnings}.${partialOuts}`);

        // Calculate average velocity
        const velocities = gameState.pitching.velocities;
        const avgVelo =
          velocities.length > 0
            ? Math.round(
                velocities.reduce((a, b) => a + b, 0) / velocities.length
              )
            : 0;

        const pitchingData = {
          role: role,
          ip: ip,
          h: gameState.pitching.stats.hits,
          r: gameState.pitching.stats.runs,
          er: gameState.pitching.stats.earnedRuns,
          bb: gameState.pitching.stats.walks,
          k: gameState.pitching.stats.strikeouts,
          hr: 0, // Not tracked in current version, default to 0
          pitches: gameState.pitching.stats.pitchCount,
          fb_velo: avgVelo,
          wp: gameState.pitching.stats.wildPitches,
          balks: gameState.pitching.stats.balks,
          pickoffs: gameState.pitching.stats.pickoffs,
        };

        // Add relief inning if applicable
        if (role === 'Relief' && reliefInning) {
          pitchingData.relief_inning = parseFloat(reliefInning);
        }

        // Add detailed pitch data
        const detailedPitches = [];
        gameState.pitching.actions.forEach((action) => {
          if (
            action.type === 'strike' ||
            action.type === 'ball' ||
            action.type === 'ballInPlay' ||
            action.type === 'wildPitch'
          ) {
            const pitch = {
              type: action.pitchType || 'Unknown',
              outcome:
                action.type === 'ballInPlay' ? 'ballInPlay' : action.type,
            };

            if (action.detail && action.type === 'strike') {
              pitch.detail = action.detail;
            }

            if (action.type === 'ballInPlay') {
              pitch.result = action.detail; // single, double, out, etc.
              if (action.hitType) {
                pitch.hitType = action.hitType;
              }
            }

            if (action.velocity) {
              pitch.velocity = action.velocity;
            }

            detailedPitches.push(pitch);
          }
        });

        if (detailedPitches.length > 0) {
          pitchingData.detailed_pitches = detailedPitches;
        }

        // Add velocities array
        if (velocities.length > 0) {
          pitchingData.velocities = velocities;
        }

        return pitchingData;
      }

      function buildBattingExport() {
        const status = document.getElementById('battingStatus').value;
        const substituteInning =
          document.getElementById('substituteInning').value;

        const stats = gameState.batting.stats;

        // Calculate total bases
        const tb =
          stats.singles + 2 * stats.doubles + 3 * stats.triples + 4 * stats.hr;

        const battingData = {
          status: status,
          pa: stats.pa,
          ab: stats.ab,
          h: stats.h,
          '1b': stats.singles, // Map to Python format
          '2b': stats.doubles, // Map to Python format
          '3b': stats.triples, // Map to Python format
          hr: stats.hr,
          iphr: stats.iphr,
          rbi: stats.rbi,
          bb: stats.bb,
          hbp: stats.hbp,
          k: stats.k,
          k_looking: stats.kLooking, // Map to Python format
          k_swinging: stats.kSwinging, // Map to Python format
          sb: stats.sb,
          cs: stats.cs,
          pik: stats.pickedOff, // Map to Python format
          sf: stats.sf,
          sh: stats.sh,
          roe: stats.roe,
          fc: stats.fc,
          tb: tb, // Add calculated field
          d3k_reached: stats.d3k_reached,
          d3k_out: stats.d3k_out,
          ci: stats.ci,
          ab_risp: stats.ab_risp,
          h_risp: stats.h_risp,
          rbi_risp: stats.rbi_risp,
        };

        // Add substitute inning if applicable
        if (status === 'Substitute' && substituteInning) {
          battingData.substitute_inning = parseInt(substituteInning);
        }

        // Add detailed plate appearances
        const plateAppearances = [];
        gameState.batting.actions.forEach((action) => {
          // Skip baserunning-only events
          if (['rbi', 'sb', 'cs', 'pickedOff'].includes(action.outcome)) {
            return;
          }

          const pa = {
            outcome: action.outcome,
            risp: action.risp,
          };

          if (action.hitType) {
            pa.hitType = action.hitType;
          }

          if (action.hitLocation) {
            pa.hitLocation = action.hitLocation;
          }

          if (action.strikeoutType) {
            pa.strikeoutType = action.strikeoutType;
          }

          if (action.strikes > 0 || action.balls > 0) {
            pa.count = {
              strikes: action.strikes,
              balls: action.balls,
            };
          }

          plateAppearances.push(pa);
        });

        if (plateAppearances.length > 0) {
          battingData.plate_appearances = plateAppearances;
        }

        return battingData;
      }

      function buildFieldingExport() {
        // Convert object structure to array structure for Python
        const fieldingArray = [];

        for (const [position, stats] of Object.entries(
          gameState.fielding.positions
        )) {
          // Calculate total chances
          const tc = stats.po + stats.assists + stats.errors;

          fieldingArray.push({
            position: position,
            innings: stats.innings,
            po: stats.po,
            a: stats.assists, // Map to Python format
            e: stats.errors,
            tc: tc, // Add calculated field
            dp: stats.dp,
          });
        }

        return fieldingArray;
      }

      function downloadJSON(data, filename) {
        // Convert to pretty JSON
        const jsonStr = JSON.stringify(data, null, 2);

        // Create blob
        const blob = new Blob([jsonStr], { type: 'application/json' });

        // Create download link
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;

        // Trigger download
        document.body.appendChild(a);
        a.click();

        // Cleanup
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // ==========================================
      // PASSWORD PROTECTION
      // ==========================================

      const CORRECT_PASSWORD = 'B3arCatZ';

      function checkPassword() {
        const input = document.getElementById('passwordInput').value;
        if (input === CORRECT_PASSWORD) {
          localStorage.setItem('trackerAuth', 'true');
          document.getElementById('passwordScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          loadGameState();
        } else {
          document.getElementById('passwordError').style.display = 'block';
          document.getElementById('passwordInput').value = '';
        }
      }

      window.addEventListener('DOMContentLoaded', function () {
        if (localStorage.getItem('trackerAuth') === 'true') {
          document.getElementById('passwordScreen').style.display = 'none';
          document.getElementById('mainApp').style.display = 'block';
          loadGameState();
          updatePositionsPlayedList();
        } else {
          document.getElementById('passwordScreen').style.display = 'flex';
          document.getElementById('mainApp').style.display = 'none';
        }
      });

      document.addEventListener('DOMContentLoaded', function () {
        document
          .getElementById('passwordInput')
          ?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkPassword();
          });
      });
    </script>
  </body>
</html>
